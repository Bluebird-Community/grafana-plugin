{"version":3,"sources":["../../../../src/datasources/perf-ds/datasource.js"],"names":["OpenNMSDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","basicAuth","withCredentials","interval","jsonData","timeInterval","timeout","parseInt","searchLimit","target","options","headers","Authorization","datasourceRequest","err","ret","statusText","cancelled","message","status","self","buildQuery","query","labels","request","source","length","doOpenNMSRequest","data","method","then","response","console","warn","reject","processMeasurementsResponse","result","sortBy","s","indexOf","label","catch","decorateError","title","undefined","resolve","interpolatedQuery","first","interpolateValue","functions","findFunctions","func","metricFindNodeFilterQuery","apply","arguments","metricFindNodeResourceQuery","params","filterRule","limit","count","totalCount","results","each","node","nodeCriteria","id","toString","foreignId","foreignSource","push","text","value","expandable","encodeURIComponent","getNodeResource","depth","children","resource","resourceWithoutNodePrefix","match","start","range","from","valueOf","end","to","step","Math","floor","maxDataPoints","intervalMs","targets","transient","hide","Attribute","nodeId","resourceId","attribute","aggregation","subattribute","datasource","fallbackAttribute","interpolateSourceVariables","scopedVars","interpolatedSource","getRemoteResourceId","concat","map","Expression","expression","interpolateExpressionVariables","Filter","filter","interpolatedFilterParms","interpolateVariables","filterParameters","keys","filters","filterParms","parameters","key","callback","entry","object","attributes","variables","templateVariable","variable","isString","current","option","comparator","orderBy","order","sysName","interpolatedNodeId","flattenResourcesWithAttributes","interpolatedResourceId","remoteResourceId","toLowerCase","rrdGraphAttributes","sort","columns","timestamps","metadata","series","i","j","nRows","nCols","datapoints","atLeastOneNonNaNValue","values","isNaN","resources","format","resourcesWithAttributes","Object","prefix"],"mappings":"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","file":"datasource.js","sourcesContent":["import {QueryType} from './constants';\nimport {interpolate} from \"./interpolate\";\nimport _ from 'lodash';\nimport {FunctionFormatter} from './function_formatter';\n\nexport class OpenNMSDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    // This variable is referenced by the calculateInterval() method in metrics_panel_ctrl.ts\n    this.interval = (instanceSettings.jsonData || {}).timeInterval;\n\n    if (instanceSettings.jsonData && instanceSettings.jsonData.timeout) {\n        this.timeout = parseInt(instanceSettings.jsonData.timeout,10) * 1000;\n    }\n\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n\n    this.searchLimit = 25;\n    this.target = {};\n  }\n\n  doOpenNMSRequest(options) {\n    if (this.basicAuth || this.withCredentials) {\n      options.withCredentials = true;\n    }\n    if (this.basicAuth) {\n      options.headers = options.headers || {};\n      options.headers.Authorization = this.basicAuth;\n    }\n\n    options.url = this.url + options.url;\n    if (this.timeout) {\n      options.timeout = this.timeout;\n    }\n\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  decorateError(err) {\n    let ret = err;\n    if (err.err) {\n      ret = err.err;\n    }\n    let statusText = ret.statusText || 'Request failed.';\n\n    // cancelled property causes the UI to never complete on failure\n    if (ret.cancelled) {\n      delete ret.cancelled;\n      statusText = 'Request timed out.';\n    }\n    if (err.cancelled) {\n      delete err.cancelled;\n      statusText = 'Request timed out.';\n    }\n\n    if (!ret.message) {\n      ret.message = statusText;\n    }\n    if (!ret.status) {\n      ret.status = 'error';\n    }\n    return ret;\n  }\n\n  query(options) {\n    const self = this;\n\n    // Generate the query\n    var [query, labels] = this.buildQuery(options);\n\n    // Issue the request\n    var request;\n    if (query.source.length > 0) {\n      request = this.doOpenNMSRequest({\n        url: '/rest/measurements',\n        data: query,\n        method: 'POST',\n        headers: {'Content-Type': 'application/json'}\n      });\n    } else {\n      // There are no sources listed, let Grafana display \"No data points\" to the user\n      return {'data': []};\n    }\n\n    return request\n      // Convert the results to the expected format\n      .then((response) => {\n        if (response.status < 200 || response.status >= 300) {\n          console.warn('Response code:',response);\n          return self.$q.reject(response);\n        }\n\n        return OpenNMSDatasource.processMeasurementsResponse(response);\n      })\n      // Sort resulting series by labels\n      .then((result) => {\n          result.data = _.sortBy(result.data, (s) => _.indexOf(labels, s.label));\n          return result;\n      })\n      .catch(err => {\n        return self.$q.reject(self.decorateError(err));\n      });\n  }\n\n  // Used for testing the connection from the datasource configuration page\n  testDatasource() {\n    return this.doOpenNMSRequest({\n      url: '/rest/info',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n      } else {\n        return {\n          status: \"danger\",\n          message: \"OpenNMS provided a response, but no metadata was found.\",\n          title: \"Unexpected Response \" + response.status\n        };\n      }\n    }).catch(err => {\n      return this.decorateError(err);\n    });\n  }\n\n  // Used by template queries\n  metricFindQuery(query) {\n    if (query === null || query === undefined || query === \"\") {\n      return this.$q.resolve([]);\n    }\n\n    var interpolatedQuery = _.first(this.interpolateValue(query));\n\n    if (interpolatedQuery !== undefined) {\n      const functions = FunctionFormatter.findFunctions(interpolatedQuery);\n\n      for (const func of functions) {\n        if (func.name === 'nodeFilter') {\n          return this.metricFindNodeFilterQuery.apply(this, func.arguments);\n        } else if (func.name === 'nodeResources') {\n          return this.metricFindNodeResourceQuery.apply(this, func.arguments);\n        } else {\n          console.warn('Unknown function in interpolated query: ' + interpolatedQuery, func);\n        }\n      }\n    }\n\n    return this.$q.resolve([]);\n  }\n\n  metricFindNodeFilterQuery(query) {\n    return this.doOpenNMSRequest({\n      url: '/rest/nodes',\n      method: 'GET',\n      params: {\n        filterRule: query,\n        limit: 0\n      }\n    }).then(function (response) {\n      if (response.data.count > response.data.totalCount) {\n        console.warn(\"Filter matches \" + response.data.totalCount + \" records, but only \" + response.data.count + \" will be used.\");\n      }\n      var results = [];\n      _.each(response.data.node, function (node) {\n        var nodeCriteria = node.id.toString();\n        if (node.foreignId !== null && node.foreignSource !== null) {\n          nodeCriteria = node.foreignSource + \":\" + node.foreignId;\n        }\n        results.push({text: node.label, value: nodeCriteria, expandable: true});\n      });\n      return results;\n    });\n  }\n\n  metricFindNodeResourceQuery(query) {\n    return this.doOpenNMSRequest({\n      url: '/rest/resources/' + encodeURIComponent(OpenNMSDatasource.getNodeResource(query)),\n      method: 'GET',\n      params: {\n        depth: 1\n      }\n    }).then(function (response) {\n      var results = [];\n      _.each(response.data.children.resource, function (resource) {\n        var resourceWithoutNodePrefix = resource.id.match(/node(Source)?\\[.*?\\]\\.(.*)/);\n        if (resourceWithoutNodePrefix) {\n          results.push({text: resourceWithoutNodePrefix[2], expandable: true});\n        }\n      });\n      return results;\n    });\n  }\n\n  buildQuery(options) {\n    var self = this,\n      start = options.range.from.valueOf(),\n      end = options.range.to.valueOf(),\n      step = Math.floor((end - start) / options.maxDataPoints);\n      step = (step < options.intervalMs) ? options.intervalMs : step;\n\n    var query = {\n      \"start\": start,\n      \"end\": end,\n      \"step\": step,\n      \"relaxed\": true, // enable relaxed mode, which allows for missing attributes\n      \"maxrows\": options.maxDataPoints,\n      \"source\": [],\n      \"expression\": []\n    };\n\n    var labels = [];\n\n    _.each(options.targets, function (target) {\n      var transient = \"false\";\n      if (target.hide) {\n        transient = true;\n      }\n\n      if (target.type === QueryType.Attribute) {\n        if (!((target.nodeId && target.resourceId && target.attribute))) {\n          return;\n        }\n\n        var label = target.label;\n        if (label === undefined || label === '') {\n          label = target.attribute;\n        }\n\n        // Build the source\n        let source = {\n          \"aggregation\": target.aggregation,\n          \"attribute\": target.attribute,\n          \"label\": label,\n          \"resourceId\": target.resourceId,\n          \"nodeId\": target.nodeId, // temporary attribute used for interpolation\n          \"transient\": transient\n        };\n\n        if (target.subattribute !== undefined && target.subattribute !== '') {\n          source.datasource = target.subattribute;\n        }\n        if (target.fallbackAttribute !== undefined && target.fallbackAttribute !== '') {\n          source['fallback-attribute'] = target.fallbackAttribute;\n        }\n\n        // Perform variable substitution - may generate additional queries\n        source = self.interpolateSourceVariables(source, options.scopedVars, (interpolatedSource) => {\n            // Calculate the effective resource id after the interpolation\n            interpolatedSource.resourceId = OpenNMSDatasource.getRemoteResourceId(interpolatedSource.nodeId, interpolatedSource.resourceId);\n            delete interpolatedSource.nodeId;\n        });\n        query.source = query.source.concat(source);\n\n        labels = labels.concat(_.map(source, 'label'));\n\n      } else if (target.type === QueryType.Expression) {\n        if (!((target.label && target.expression))) {\n          return;\n        }\n\n        // Build the expression\n        let expression = {\n          \"label\": target.label,\n          \"value\": target.expression,\n          \"transient\": transient\n        };\n\n        // Perform variable substitution - may generate additional expressions\n        expression = self.interpolateExpressionVariables(expression, options.scopedVars);\n        query.expression = query.expression.concat(expression);\n\n        labels = labels.concat(_.map(expression, 'label'));\n\n      } else if (target.type === QueryType.Filter) {\n        if (!((target.filter))) {\n          return;\n        }\n\n        // Interpolate the filter parameters\n        var interpolatedFilterParms = self.interpolateVariables(target.filterParameters, _.keys(target.filterParameters), options.scopedVars);\n\n        var filters = _.map(interpolatedFilterParms, (filterParms) => {\n          // Build the filter definition\n          var parameters = [];\n          _.each(filterParms, function (value, key) {\n            // Skip parameters with undefined or empty values\n            if (value === undefined || value === '' || value === null) {\n              return;\n            }\n\n            parameters.push({\n              'key': key,\n              'value': value\n            });\n          });\n\n          return {\n            \"name\": target.filter.name,\n            \"parameter\": parameters\n          };\n        });\n\n        // Only add the filter attribute to the query when one or more filters are specified since\n        // OpenNMS versions before 17.0.0 do not support it\n        if (!query.filter) {\n          query.filter = filters;\n        } else {\n          query.filter = query.filter.concat(filters);\n        }\n      }\n    });\n\n    return [query, labels];\n  }\n\n  interpolateSourceVariables(source, scopedVars, callback) {\n    return this.interpolateVariables(source, ['nodeId', 'resourceId', 'attribute', 'datasource', 'label'], scopedVars, callback);\n  }\n\n  interpolateExpressionVariables(expression, scopedVars) {\n    return this.interpolateVariables(expression, ['value', 'label'], scopedVars);\n  }\n\n  interpolateValue(value, scopedVars) {\n    return _.map(this.interpolateVariables({'value': value}, ['value'], scopedVars), function(entry) {\n      return entry.value;\n    });\n  }\n\n  interpolateVariables(object, attributes, scopedVars, callback) {\n    // Reformat the variables to work with our interpolate function\n    var variables = [];\n    _.each(this.templateSrv.variables, function(templateVariable) {\n      var variable = {\n        name: templateVariable.name,\n        value: []\n      };\n\n      // If this templateVar exists in scopedVars, we need to look at the scoped values\n      if (scopedVars && scopedVars[variable.name] !== undefined) {\n        variable.value.push(scopedVars[variable.name].value);\n      } else {\n        // Single-valued?\n        if (_.isString(templateVariable.current.value)) {\n          variable.value.push(templateVariable.current.value);\n        } else {\n          _.each(templateVariable.current.value, function(value) {\n            if (value === \"$__all\") {\n              _.each(templateVariable.options, function(option) {\n                // \"All\" is part of the options, so make sure to skip that one\n                if (option.value !== \"$__all\") {\n                  variable.value.push(option.value);\n                }\n              });\n            } else {\n              variable.value.push(value);\n            }\n          });\n        }\n      }\n\n      variables.push(variable);\n    });\n    return interpolate(object, attributes, variables, callback);\n  }\n\n  static processMeasurementsResponse(response) {\n    var labels = response.data.labels;\n    var columns = response.data.columns;\n    var timestamps = response.data.timestamps;\n    var metadata = response.data.metadata;\n    var series = [];\n    var i, j, nRows, nCols, datapoints;\n    var value, atLeastOneNonNaNValue;\n\n    if (timestamps !== undefined) {\n      nRows = timestamps.length;\n      nCols = columns.length;\n\n      for (i = 0; i < nCols; i++) {\n        atLeastOneNonNaNValue = false;\n        datapoints = [];\n        for (j = 0; j < nRows; j++) {\n          // Skip rows that are out-of-ranges - this can happen with RRD data in narrow time spans\n          if (timestamps[j] < response.data.start || timestamps[j] > response.data.end) {\n            continue;\n          }\n\n          value = columns[i].values[j];\n          if (!atLeastOneNonNaNValue && !isNaN(value)) {\n            atLeastOneNonNaNValue = true;\n          }\n          datapoints.push([columns[i].values[j], timestamps[j]]);\n        }\n\n        let label = labels[i];\n        if (metadata && metadata.resources) {\n          label = FunctionFormatter.format(label, metadata);\n        }\n\n        // Skip series that are all NaNs\n        // When querying in relaxed mode, expressions that operate against attribute that are missing may only contain\n        // NaNs. In this case, we don't want to show them at all.\n        if (atLeastOneNonNaNValue) {\n          series.push({\n            target: label,\n            label: labels[i],\n            datapoints: datapoints\n          });\n        }\n      }\n    }\n\n    return {data: series};\n  }\n\n  static flattenResourcesWithAttributes(resources, resourcesWithAttributes) {\n    _.each(resources, function (resource) {\n      if (resource.rrdGraphAttributes !== undefined && Object.keys(resource.rrdGraphAttributes).length > 0) {\n        resourcesWithAttributes.push(resource);\n      }\n      if (resource.children !== undefined && resource.children.resource.length > 0) {\n        OpenNMSDatasource.flattenResourcesWithAttributes(resource.children.resource, resourcesWithAttributes);\n      }\n    });\n    return resourcesWithAttributes;\n  }\n\n  static getNodeResource(nodeId) {\n    var prefix = \"\";\n    if (nodeId.indexOf(\":\") > 0) {\n      prefix = \"nodeSource[\";\n    } else {\n      prefix = \"node[\";\n    }\n    return prefix + nodeId + \"]\";\n  }\n\n  static getRemoteResourceId(nodeId, resourceId) {\n    return OpenNMSDatasource.getNodeResource(nodeId) + \".\" + resourceId;\n  }\n\n  searchForNodes(query) {\n    return this.doOpenNMSRequest({\n      url: '/rest/nodes',\n      method: 'GET',\n      params: {\n        limit: this.searchLimit,\n        match: 'any',\n        comparator: 'ilike',\n        orderBy: 'id',\n        order: 'asc',\n        label: '%' + query + '%',\n        sysName: '%' + query + '%',\n        'ipInterface.ipAddress': '%' + query + '%',\n        'ipInterface.ipHostName': '%' + query + '%',\n        'foreignId': query + '%' // doesn't support leading '%'\n      }\n    });\n  }\n\n  getResourcesWithAttributesForNode(nodeId) {\n    var interpolatedNodeId = _.first(this.interpolateValue(nodeId));\n\n    return this.doOpenNMSRequest({\n      url: '/rest/resources/fornode/' + encodeURIComponent(interpolatedNodeId),\n      method: 'GET',\n      params: {\n        depth: -1\n      }\n    }).then(function (results) {\n      return OpenNMSDatasource.flattenResourcesWithAttributes([results.data], []);\n    });\n  }\n\n  getAvailableFilters() {\n    return this.doOpenNMSRequest({\n      url: '/rest/measurements/filters',\n      method: 'GET'\n    });\n  }\n\n  suggestAttributes(nodeId, resourceId, query) {\n    var interpolatedNodeId = _.first(this.interpolateValue(nodeId)),\n        interpolatedResourceId = _.first(this.interpolateValue(resourceId));\n    var remoteResourceId = OpenNMSDatasource.getRemoteResourceId(interpolatedNodeId, interpolatedResourceId);\n\n    return this.doOpenNMSRequest({\n      url: '/rest/resources/' + encodeURIComponent(remoteResourceId),\n      method: 'GET',\n      params: {\n        depth: -1\n      }\n    }).then(function (results) {\n      query = query.toLowerCase();\n      var attributes = [];\n      _.each(results.data.rrdGraphAttributes, function (value, key) {\n        if (key.toLowerCase().indexOf(query) >= 0) {\n          attributes.push(key);\n        }\n      });\n      attributes.sort();\n\n      return attributes;\n    });\n  }\n}\n"]}