{"version":3,"sources":["../../../../src/datasources/flow-ds/func_editor.js"],"names":["angular","module","directive","$compile","templateSrv","funcSpanTemplate","paramTemplate","funcControlsTemplate","restrict","link","postLink","$scope","elem","$funcLink","$","$funcControls","ctrl","func","funcDef","def","scheduledRelink","paramCountAtLink","clickFuncParam","paramIndex","$link","$input","next","val","params","css","width","hide","show","focus","select","typeahead","data","lookup","scheduledRelinkIfNeeded","length","setTimeout","relink","inputBlur","prev","newValue","optional","html","highlightVariablesAsHtml","updateParam","$apply","targetChanged","inputKeyPress","e","which","call","inputKeyDown","style","value","addTypeahead","attr","options","type","map","toString","source","minLength","items","updater","query","$element","process","toggleFuncControls","targetDiv","closest","hasClass","removeClass","addClass","addElementsAndCompile","appendTo","each","param","index","paramValue","$paramLink","blur","partial","keyup","keypress","click","contents","ifJustAddedFocusFistParam","added","find","first","registerFuncControlsToggle","registerFuncControlsActions","$target","target","removeFunction","move","functions","$index","children","remove"],"mappings":"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","file":"func_editor.js","sourcesContent":["import _ from 'lodash';\n\n/**\n * This function editor has been adapted from the Graphite query editor's functione editor.\n */\nangular\n  .module('grafana.directives')\n  .directive('opennmsFuncEditor', function ($compile, templateSrv) {\n\n    let funcSpanTemplate = '<a ng-click=\"\">{{func.def.name}}</a><span>(</span>';\n    let paramTemplate = '<input type=\"text\" style=\"display:none\"' +\n      ' class=\"input-mini tight-form-func-param\"></input>';\n\n    let funcControlsTemplate =\n      '<div class=\"tight-form-func-controls\">' +\n      '<span class=\"pointer fa fa-arrow-left\"></span>' +\n      '<span class=\"pointer fa fa-remove\" ></span>' +\n      '<span class=\"pointer fa fa-arrow-right\"></span>' +\n      '</div>';\n\n    return {\n      restrict: 'A',\n      link: function postLink($scope, elem) {\n        let $funcLink = $(funcSpanTemplate);\n        let $funcControls = $(funcControlsTemplate);\n        let ctrl = $scope.ctrl;\n        let func = $scope.func;\n        let funcDef = func.def;\n        let scheduledRelink = false;\n        let paramCountAtLink = 0;\n\n        function clickFuncParam(paramIndex) {\n          /*jshint validthis:true */\n\n          let $link = $(this);\n          let $input = $link.next();\n\n          $input.val(func.params[paramIndex]);\n          $input.css('width', ($link.width() + 16) + 'px');\n\n          $link.hide();\n          $input.show();\n          $input.focus();\n          $input.select();\n\n          let typeahead = $input.data('typeahead');\n          if (typeahead) {\n            $input.val('');\n            typeahead.lookup();\n          }\n        }\n\n        function scheduledRelinkIfNeeded() {\n          if (paramCountAtLink === func.params.length) {\n            return;\n          }\n\n          if (!scheduledRelink) {\n            scheduledRelink = true;\n            setTimeout(function () {\n              relink();\n              scheduledRelink = false;\n            }, 200);\n          }\n        }\n\n        function inputBlur(paramIndex) {\n          /*jshint validthis:true */\n          let $input = $(this);\n          let $link = $input.prev();\n          let newValue = $input.val();\n\n          if (newValue !== '' || func.def.params[paramIndex].optional) {\n            $link.html(templateSrv.highlightVariablesAsHtml(newValue));\n\n            func.updateParam($input.val(), paramIndex);\n            scheduledRelinkIfNeeded();\n\n            $scope.$apply(function () {\n              ctrl.targetChanged();\n            });\n\n            $input.hide();\n            $link.show();\n          }\n        }\n\n        function inputKeyPress(paramIndex, e) {\n          /*jshint validthis:true */\n          if (e.which === 13) {\n            inputBlur.call(this, paramIndex);\n          }\n        }\n\n        function inputKeyDown() {\n          /*jshint validthis:true */\n          this.style.width = (3 + this.value.length) * 8 + 'px';\n        }\n\n        function addTypeahead($input, paramIndex) {\n          $input.attr('data-provide', 'typeahead');\n\n          let options = funcDef.params[paramIndex].options;\n          if (funcDef.params[paramIndex].type === 'int') {\n            options = _.map(options, function (val) {\n              return val.toString();\n            });\n          }\n\n          $input.typeahead({\n            source: options,\n            minLength: 0,\n            items: 20,\n            updater: function (value) {\n              setTimeout(function () {\n                inputBlur.call($input[0], paramIndex);\n              }, 0);\n              return value;\n            }\n          });\n\n          let typeahead = $input.data('typeahead');\n          typeahead.lookup = function () {\n            this.query = this.$element.val() || '';\n            return this.process(this.source);\n          };\n        }\n\n        function toggleFuncControls() {\n          let targetDiv = elem.closest('.tight-form');\n\n          if (elem.hasClass('show-function-controls')) {\n            elem.removeClass('show-function-controls');\n            targetDiv.removeClass('has-open-function');\n            $funcControls.hide();\n            return;\n          }\n\n          elem.addClass('show-function-controls');\n          targetDiv.addClass('has-open-function');\n\n          $funcControls.show();\n        }\n\n        function addElementsAndCompile() {\n          $funcControls.appendTo(elem);\n          $funcLink.appendTo(elem);\n\n          _.each(funcDef.params, function (param, index) {\n            if (param.optional && func.params.length <= index) {\n              return;\n            }\n\n            if (index > 0) {\n              $('<span>, </span>').appendTo(elem);\n            }\n\n            let paramValue = templateSrv.highlightVariablesAsHtml(func.params[index]);\n            let $paramLink = $('<a ng-click=\"\" class=\"graphite-func-param-link\">' + paramValue + '</a>');\n            let $input = $(paramTemplate);\n\n            paramCountAtLink++;\n\n            $paramLink.appendTo(elem);\n            $input.appendTo(elem);\n\n            $input.blur(_.partial(inputBlur, index));\n            $input.keyup(inputKeyDown);\n            $input.keypress(_.partial(inputKeyPress, index));\n            $paramLink.click(_.partial(clickFuncParam, index));\n\n            if (funcDef.params[index].options) {\n              addTypeahead($input, index);\n            }\n\n          });\n\n          $('<span>)</span>').appendTo(elem);\n\n          $compile(elem.contents())($scope);\n        }\n\n        function ifJustAddedFocusFistParam() {\n          if ($scope.func.added) {\n            $scope.func.added = false;\n            setTimeout(function () {\n              elem.find('.graphite-func-param-link').first().click();\n            }, 10);\n          }\n        }\n\n        function registerFuncControlsToggle() {\n          $funcLink.click(toggleFuncControls);\n        }\n\n        function registerFuncControlsActions() {\n          $funcControls.click(function (e) {\n            let $target = $(e.target);\n            if ($target.hasClass('fa-remove')) {\n              toggleFuncControls();\n              $scope.$apply(function () {\n                ctrl.removeFunction($scope.func);\n              });\n              return;\n            }\n\n            if ($target.hasClass('fa-arrow-left')) {\n              $scope.$apply(function () {\n                _.move(ctrl.functions, $scope.$index, $scope.$index - 1);\n                ctrl.targetChanged();\n              });\n              return;\n            }\n\n            if ($target.hasClass('fa-arrow-right')) {\n              $scope.$apply(function () {\n                _.move(ctrl.functions, $scope.$index, $scope.$index + 1);\n                ctrl.targetChanged();\n              });\n              return;\n            }\n          });\n        }\n\n        function relink() {\n          elem.children().remove();\n\n          addElementsAndCompile();\n          ifJustAddedFocusFistParam();\n          registerFuncControlsToggle();\n          registerFuncControlsActions();\n        }\n\n        relink();\n      }\n    };\n\n  });"]}