{"version":3,"sources":["../../../../src/datasources/flow-ds/datasource.js"],"names":["FlowDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","client","options","start","range","from","valueOf","end","to","step","Math","floor","maxDataPoints","targets","length","Error","target","metric","undefined","when","N","getFunctionParameterOrDefault","includeOther","isFunctionPresent","exporterNode","ifIndex","asTableSummary","getSeriesForTopNConversations","then","data","toSeries","series","getSummaryForTopNConversations","toTable","table","getSeriesForTopNApplications","getSummaryForTopNApplications","getClientWithMetadata","metadata","status","message","title","catch","e","query","resolve","replace","exporterNodesRegex","interfacesOnExporterNodeRegex","exporterNodesQuery","match","metricFindExporterNodes","interfacesOnExporterNodeQuery","metricFindInterfacesOnExporterNode","defaultRangeMs","parseInt","getExporters","results","each","exporters","exporter","push","text","label","value","id","expandable","getExporter","interfaces","iff","index","idx","def","func","getFirstFunction","parameters","columns","map","headers","column","rows","flowSeries","perSecond","negativeEgress","negativeIngress","combineIngressEgress","values","timestamps","i","j","nRows","nCols","datapoints","multiplier","suffix","ingress","sumMatchingTargets","targetsByName","groupBy","s","newSeries","t","K","summedDatapoints","Array","k","targetDatapoints","n","valueToAdd","matchingFunctions","filter","functions","f"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport {ClientDelegate} from '../../lib/client_delegate';\n\nexport class FlowDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.client = new ClientDelegate(instanceSettings, backendSrv, $q);\n  }\n\n  query(options) {\n    let start = options.range.from.valueOf();\n    let end = options.range.to.valueOf();\n    let step = Math.floor((end - start) / options.maxDataPoints);\n\n    if (options.targets.length > 1) {\n      throw new Error(\"Multiple targets are not currently supported when using the OpenNMS Flow Datasource.\");\n    }\n\n    // Grab the first target\n    let target = options.targets[0];\n    if (target.metric === undefined || target.metric === null) {\n      // Nothing to query - this can happen when we initially create the panel\n      // and have not yet selected a metric\n      return this.q.when({'data': []});\n    }\n\n    // Combine\n    let N = this.getFunctionParameterOrDefault(target, 'topN', 10);\n    let includeOther = FlowDatasource.isFunctionPresent(target, 'includeOther');\n    // Filter\n    let exporterNode = this.getFunctionParameterOrDefault(target, 'withExporterNode', 0);\n    let ifIndex = this.getFunctionParameterOrDefault(target, 'withIfIndex', 0);\n    // Transform\n    let asTableSummary = FlowDatasource.isFunctionPresent(target, 'asTableSummary');\n\n    if (target.metric === 'conversations') {\n      if (!asTableSummary) {\n        return this.client.getSeriesForTopNConversations(N, start, end, step, exporterNode, ifIndex).then(series => {\n          return {\n            data: FlowDatasource.toSeries(target, series)\n          };\n        });\n      } else {\n        return this.client.getSummaryForTopNConversations(N, start, end, exporterNode, ifIndex).then(table => {\n          return {\n            data: FlowDatasource.toTable(table)\n          };\n        });\n      }\n    } else if (target.metric === 'applications') {\n      if (!asTableSummary) {\n        return this.client.getSeriesForTopNApplications(N, start, end, step, includeOther, exporterNode, ifIndex).then(series => {\n          return {\n            data: FlowDatasource.toSeries(target, series)\n          };\n        });\n      } else {\n        return this.client.getSummaryForTopNApplications(N, start, end, includeOther, exporterNode, ifIndex).then(table => {\n          return {\n            data: FlowDatasource.toTable(table)\n          };\n        });\n      }\n    } else {\n      throw 'Unsupported target metric: ' + target.metric;\n    }\n  }\n\n  testDatasource() {\n    return this.client.getClientWithMetadata()\n      .then(metadata => {\n        if (metadata) {\n          return {\n            status: \"success\",\n            message: \"Data source is working\",\n            title: \"Success\"\n          };\n        } else {\n          return {\n            status: \"danger\",\n            message: \"OpenNMS provided a response, but no metadata was found.\",\n            title: \"Unexpected Response\"\n          }\n        }\n      }).catch(e => {\n        if (e.message === \"Unsupported Version\") {\n          return {\n            status: \"danger\",\n            message: \"The OpenNMS version you are trying to connect to is not supported. \" +\n            \"OpenNMS Horizon version >= 22.0.0 or OpenNMS Meridian version >= 2018.1.0 is required.\",\n            title: e.message\n          }\n        } else {\n          throw e;\n        }\n      });\n  }\n\n  annotationQuery(options) {\n    return this.q.when([]);\n  }\n\n  // Used by template queries\n  metricFindQuery(query) {\n    if (query === null || query === undefined || query === \"\") {\n      return this.$q.resolve([]);\n    }\n    query = this.templateSrv.replace(query);\n\n    let exporterNodesRegex = /exporterNodesWithFlows\\((.*)\\)/;\n    let interfacesOnExporterNodeRegex = /interfacesOnExporterNodeWithFlows\\((.*)\\)/;\n\n    let exporterNodesQuery = query.match(exporterNodesRegex);\n    if (exporterNodesQuery) {\n      return this.metricFindExporterNodes(exporterNodesQuery[1]);\n    }\n\n    let interfacesOnExporterNodeQuery = query.match(interfacesOnExporterNodeRegex);\n    if (interfacesOnExporterNodeQuery) {\n      return this.metricFindInterfacesOnExporterNode(interfacesOnExporterNodeQuery[1]);\n    }\n\n    return this.$q.resolve([]);\n  }\n\n  metricFindExporterNodes(query) {\n    const defaultRangeMs = 14400000;\n    let range = defaultRangeMs;\n    if (query != null && query.length > 0) {\n      range = parseInt(query) || defaultRangeMs;\n    }\n    return this.client.getExporters(-range, 0).then(exporters => {\n      let results = [];\n      _.each(exporters, function (exporter) {\n        results.push({text: exporter.label, value: exporter.id, expandable: true});\n      });\n      return results;\n    });\n  }\n\n  metricFindInterfacesOnExporterNode(query) {\n    return this.client.getExporter(query).then(exporter => {\n      let results = [];\n      _.each(exporter.interfaces, function (iff) {\n        results.push({text: iff.name + \"(\" + iff.index + \")\", value: iff.index, expandable: true});\n      });\n      return results;\n    });\n  }\n\n  static toTable(table) {\n    let columns = _.map(table.headers, column => {\n      return {\"text\": column}\n    });\n\n    return [\n      {\n        \"columns\": columns,\n        \"rows\": table.rows,\n        \"type\": \"table\",\n      }\n    ];\n  }\n\n  static toSeries(target, flowSeries) {\n    let perSecond = FlowDatasource.isFunctionPresent(target, 'perSecond');\n    let negativeEgress = FlowDatasource.isFunctionPresent(target, 'negativeEgress');\n    let negativeIngress = FlowDatasource.isFunctionPresent(target, 'negativeIngress');\n    let combineIngressEgress = FlowDatasource.isFunctionPresent(target, 'combineIngressEgress');\n\n    let start = flowSeries.start.valueOf();\n    let end = flowSeries.end.valueOf();\n    let columns = flowSeries.columns;\n    let values = flowSeries.values;\n    let timestamps = flowSeries.timestamps;\n    let series = [];\n    let i, j, nRows, nCols, datapoints;\n\n    let step = timestamps[1] - timestamps[0];\n\n    if (timestamps !== undefined) {\n      nRows = timestamps.length;\n      nCols = columns.length;\n\n      for (i = 0; i < nCols; i++) {\n        let multiplier = negativeIngress ? -1 : 1;\n        let suffix = \" (In)\";\n        if (!columns[i].ingress) {\n          multiplier = negativeEgress ? -1 : 1;\n          suffix = \" (Out)\";\n        }\n        if (combineIngressEgress) {\n          // Remove any suffix, so that ingress and egress both have the same label\n          suffix = \"\";\n        }\n        if (perSecond) {\n          multiplier /= step / 1000;\n        }\n\n        datapoints = [];\n        for (j = 0; j < nRows; j++) {\n          // Skip rows that are out-of-range\n          if (timestamps[j] < start || timestamps[j] > end) {\n            continue;\n          }\n\n          if (values[i][j] === 'NaN') {\n            values[i][j] = null;\n          }\n\n          datapoints.push([values[i][j] * multiplier, timestamps[j]]);\n        }\n\n        series.push({\n          target: columns[i].label + suffix,\n          datapoints: datapoints\n        });\n      }\n    }\n\n    if (combineIngressEgress) {\n      series = FlowDatasource.sumMatchingTargets(series);\n    }\n\n    return series;\n  }\n\n  static sumMatchingTargets(series) {\n    let targetsByName = _.groupBy(series, (s) => s.target);\n    let newSeries = [];\n    _.each(targetsByName, (t) => {\n      let target = t[0].target;\n      let K = t.length;\n      let N = t[0].datapoints.length;\n      let summedDatapoints = new Array(N);\n      for (let k = 0; k < K; k++) {\n        let targetDatapoints = t[k].datapoints;\n        for (let n = 0; n < N; n++) {\n          if (summedDatapoints[n] == null) {\n            summedDatapoints[n] = [0, targetDatapoints[n][1]];\n          }\n          let valueToAdd = targetDatapoints[n][0] == null ? 0 : targetDatapoints[n][0];\n          summedDatapoints[n][0] = summedDatapoints[n][0] + valueToAdd;\n        }\n      }\n      newSeries.push({\n        target: target,\n        datapoints: summedDatapoints\n      })\n    });\n    return newSeries;\n  }\n\n  static getFirstFunction(target, name) {\n    let matchingFunctions = _.filter(target.functions, function (f) {\n      return f.name === name;\n    });\n    return matchingFunctions.length > 0 ? matchingFunctions[0] : null;\n  }\n\n  static isFunctionPresent(target, name) {\n    return FlowDatasource.getFirstFunction(target, name) !== null;\n  }\n\n  getFunctionParameterOrDefault(target, name, idx, def) {\n    let func = FlowDatasource.getFirstFunction(target, name);\n    if (func === null) {\n      // No match, use the default value\n      return def;\n    }\n    // Return the parameter value, and perform any required template variable substitutions\n    return this.templateSrv.replace(func.parameters[idx]);\n  }\n}\n"]}