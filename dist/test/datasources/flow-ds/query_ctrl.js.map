{"version":3,"sources":["../../../../src/datasources/flow-ds/query_ctrl.js"],"names":["FlowDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","scope","parseTarget","segments","functions","error","target","metric","push","getSegmentForValue","map","f","funcDef","getFuncDef","name","func","createFuncInstance","i","parameters","length","updateParam","newSelectMetric","value","undefined","render","Promise","resolve","newFunc","withDefaultParams","added","targetChanged","without","oldTarget","updateModelTarget","lastSegment","panelCtrl","refresh","templateUrl"],"mappings":";;;;;;;;;AAAA;;AACA;;;;AAEA;;AACA;;AACA;;AACA;;;;;;;;;;IAEaA,uB,WAAAA,uB;;;AAEX,mCAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,YAA/B,EAA6C;AAAA;;AAAA,kJACrCF,MADqC,EAC7BC,SAD6B;;AAG3C,UAAKE,KAAL,GAAaH,MAAb;AACA,UAAKE,YAAL,GAAoBA,YAApB;AACA,UAAKE,WAAL;AAL2C;AAM5C;;;;kCAEa;AACZ,WAAKC,QAAL,GAAgB,EAAhB;AACA,WAAKC,SAAL,GAAiB,EAAjB;AACA,WAAKC,KAAL,GAAa,IAAb;;AAEA,UAAI,KAAKC,MAAT,EAAiB;AACf,YAAI,KAAKA,MAAL,CAAYC,MAAhB,EAAwB;AACtB,eAAKJ,QAAL,CAAcK,IAAd,CAAmB,KAAKR,YAAL,CAAkBS,kBAAlB,CAAqC,KAAKH,MAAL,CAAYC,MAAjD,CAAnB;AACD;;AAED,YAAI,KAAKD,MAAL,CAAYF,SAAhB,EAA2B;AACzB,eAAKA,SAAL,GAAiB,iBAAEM,GAAF,CAAM,KAAKJ,MAAL,CAAYF,SAAlB,EAA6B,UAAUO,CAAV,EAAa;AACzD,gBAAIC,UAAU,uBAAOC,UAAP,CAAkBF,EAAEG,IAApB,CAAd;AACA,gBAAIC,OAAO,uBAAOC,kBAAP,CAA0BJ,OAA1B,CAAX;AACA,iBAAK,IAAIK,IAAI,CAAb,EAAgBA,IAAIN,EAAEO,UAAF,CAAaC,MAAjC,EAAyCF,GAAzC,EAA8C;AAC5CF,mBAAKK,WAAL,CAAiBT,EAAEO,UAAF,CAAaD,CAAb,CAAjB,EAAkCA,CAAlC;AACD;AACD,mBAAOF,IAAP;AACD,WAPgB,CAAjB;AAQD;AACF;;AAED,UAAI,KAAKZ,QAAL,CAAcgB,MAAd,KAAyB,CAA7B,EAAgC;AAC9B,aAAKhB,QAAL,CAAcK,IAAd,CAAmB,KAAKR,YAAL,CAAkBqB,eAAlB,EAAnB;AACD;AACF;;;wCAEmB;AAClB,WAAKf,MAAL,CAAYC,MAAZ,GAAqB,KAAKJ,QAAL,CAAcgB,MAAd,GAAuB,CAAvB,GAA2B,KAAKhB,QAAL,CAAc,CAAd,EAAiBmB,KAA5C,GAAoDC,SAAzE;AACA,WAAKjB,MAAL,CAAYF,SAAZ,GAAwB,iBAAEM,GAAF,CAAM,KAAKN,SAAX,EAAsB,UAAUO,CAAV,EAAa;AACzD,eAAOA,EAAEa,MAAF,EAAP;AACD,OAFuB,CAAxB;AAGD;;;qCAEgB;AACf,aAAOC,QAAQC,OAAR,CAAgB,CACrB,EAACJ,OAAO,eAAR,EADqB,EAErB,EAACA,OAAO,cAAR,EAFqB,CAAhB,CAAP;AAID;;;gCAEWV,O,EAAS;AACnB,UAAIe,UAAU,uBAAOX,kBAAP,CAA0BJ,OAA1B,EAAmC,EAACgB,mBAAmB,IAApB,EAAnC,CAAd;AACAD,cAAQE,KAAR,GAAgB,IAAhB;AACA,WAAKzB,SAAL,CAAeI,IAAf,CAAoBmB,OAApB;AACA,WAAKG,aAAL;AACD;;;mCAEcf,I,EAAM;AACnB,WAAKX,SAAL,GAAiB,iBAAE2B,OAAF,CAAU,KAAK3B,SAAf,EAA0BW,IAA1B,CAAjB;AACA,WAAKe,aAAL;AACD;;;oCAEe;AACd,UAAI,KAAKzB,KAAT,EAAgB;AACd;AACD;;AAED,UAAI2B,YAAY,KAAK1B,MAAL,CAAYA,MAA5B;AACA,WAAK2B,iBAAL;;AAEA,UAAI,KAAK3B,MAAL,CAAYA,MAAZ,KAAuB0B,SAA3B,EAAsC;AACpC,YAAIE,cAAc,KAAK/B,QAAL,CAAcgB,MAAd,GAAuB,CAAvB,GAA2B,KAAKhB,QAAL,CAAc,KAAKA,QAAL,CAAcgB,MAAd,GAAuB,CAArC,CAA3B,GAAqE,EAAvF;AACA,YAAIe,YAAYZ,KAAZ,KAAsB,eAA1B,EAA2C;AACzC,eAAKa,SAAL,CAAeC,OAAf;AACD;AACF;;AAED,WAAKA,OAAL;AACD;;;wCAEmB;AAClB,WAAKD,SAAL,CAAeC,OAAf,GADkB,CACQ;AAC3B;;;;;;AAGHvC,wBAAwBwC,WAAxB,GAAsC,gDAAtC","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\n\nimport './add_opennms_func';\nimport './func_editor';\nimport {Gfuncs} from \"./flow_functions\";\nimport './css/query-editor.css!';\n\nexport class FlowDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n\n    this.scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.parseTarget();\n  }\n\n  parseTarget() {\n    this.segments = [];\n    this.functions = [];\n    this.error = null;\n\n    if (this.target) {\n      if (this.target.metric) {\n        this.segments.push(this.uiSegmentSrv.getSegmentForValue(this.target.metric));\n      }\n\n      if (this.target.functions) {\n        this.functions = _.map(this.target.functions, function (f) {\n          let funcDef = Gfuncs.getFuncDef(f.name);\n          let func = Gfuncs.createFuncInstance(funcDef);\n          for (let i = 0; i < f.parameters.length; i++) {\n            func.updateParam(f.parameters[i], i);\n          }\n          return func;\n        });\n      }\n    }\n\n    if (this.segments.length === 0) {\n      this.segments.push(this.uiSegmentSrv.newSelectMetric());\n    }\n  }\n\n  updateModelTarget() {\n    this.target.metric = this.segments.length > 0 ? this.segments[0].value : undefined;\n    this.target.functions = _.map(this.functions, function (f) {\n      return f.render();\n    });\n  }\n\n  getAltSegments() {\n    return Promise.resolve([\n      {value: 'conversations'},\n      {value: 'applications'}\n    ]);\n  }\n\n  addFunction(funcDef) {\n    let newFunc = Gfuncs.createFuncInstance(funcDef, {withDefaultParams: true});\n    newFunc.added = true;\n    this.functions.push(newFunc);\n    this.targetChanged();\n  }\n\n  removeFunction(func) {\n    this.functions = _.without(this.functions, func);\n    this.targetChanged();\n  }\n\n  targetChanged() {\n    if (this.error) {\n      return;\n    }\n\n    let oldTarget = this.target.target;\n    this.updateModelTarget();\n\n    if (this.target.target !== oldTarget) {\n      let lastSegment = this.segments.length > 0 ? this.segments[this.segments.length - 1] : {};\n      if (lastSegment.value !== 'select metric') {\n        this.panelCtrl.refresh();\n      }\n    }\n\n    this.refresh();\n  }\n\n  refreshMetricData() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n}\n\nFlowDatasourceQueryCtrl.templateUrl = 'datasources/flow-ds/partials/query.editor.html';\n"]}