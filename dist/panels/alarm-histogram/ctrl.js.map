{"version":3,"sources":["../../../src/panels/alarm-histogram/ctrl.js"],"names":["MetricsPanelCtrl","_","$","AlarmHistogramCtrl","$scope","$injector","$timeout","scope","_renderRetries","defaults","panel","groupProperty","direction","retryTimes","retryDelay","events","on","onInitEditMode","bind","onDataReceived","onDataError","onRender","elem","attrs","ctrl","find","addEditorTab","data","counts","countBy","query","isNil","series","name","count","defaultTo","color","$root","colors","render","height","row","isString","parseInt","replace","width","undefined","console","log","title","css","plot","map","serie","bars","show","barWidth","align","fill","lineWidth","horizontal","yaxis","mode","tickLength","autoscaleMargin","grid","borderWidth","xaxis","column","result","i","length","columnIndex","findIndex","columns","text","rows","j","push","templateUrl"],"mappings":"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","file":"ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from \"app/plugins/sdk\";\nimport _ from \"lodash\";\nimport $ from \"jquery\";\nimport \"jquery.flot\";\nimport \"jquery.flot.selection\";\nimport \"jquery.flot.crosshair\";\nimport \"../../jquery.flot.categories\";\n\n\nclass AlarmHistogramCtrl extends MetricsPanelCtrl {\n\n    constructor($scope, $injector, $timeout) {\n        super($scope, $injector);\n\n        this.scope = $scope;\n        this.$timeout = $timeout;\n\n        this._renderRetries = 0;\n\n        _.defaults(this.panel, {\n            groupProperty: 'acknowledged',\n            direction: 'horizontal',\n        });\n\n        this.retryTimes = 10; // number of times to retry\n        this.retryDelay = 100; // milliseconds, how long to wait to retry\n\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n        this.events.on('data-received', this.onDataReceived.bind(this));\n        this.events.on('data-error', this.onDataError.bind(this));\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n        this.events.on('render', this.onRender.bind(this));\n    }\n\n    link($scope, elem, attrs, ctrl) {\n        this.elem = elem.find('.histogram-chart');\n        this.ctrl = ctrl;\n    }\n\n    onInitEditMode() {\n        this.addEditorTab('Grouping', 'public/plugins/opennms-helm-app/panels/alarm-histogram/editor.html', 2);\n    }\n\n    onDataReceived(data) {\n        switch (this.panel.groupProperty) {\n            case 'acknowledged': {\n                const counts = _.countBy(this.query(data, 'Acked By'), _.isNil);\n                this.series = [\n                    {\n                        name: 'Outstanding',\n                        count: _.defaultTo(counts[true], 0),\n                        color: this.scope.$root.colors[0],\n                    },\n                    {\n                        name: 'Acknowledged',\n                        count: _.defaultTo(counts[false], 0),\n                        color: this.scope.$root.colors[4],\n                    },\n                ];\n                break;\n            }\n\n            case 'severity': {\n                const counts = _.countBy(this.query(data, 'Severity'));\n                this.series = [\n                    {\n                        name: 'Cleared',\n                        count: _.defaultTo(counts['CLEARED'], 0),\n                        color: '#EEE000',\n                    },\n                    {\n                        name: 'Normal',\n                        count: _.defaultTo(counts['NORMAL'], 0),\n                        color: '#86B15B',\n                    },\n                    {\n                        name: 'Indeterm.',\n                        count: _.defaultTo(counts['INDETERMINATE'], 0),\n                        color: '#990000',\n                    },\n                    {\n                        name: 'Warning',\n                        count: _.defaultTo(counts['WARNING'], 0),\n                        color: '#FCCC3B',\n                    },\n                    {\n                        name: 'Minor',\n                        count: _.defaultTo(counts['MINOR'], 0),\n                        color: '#EE901C',\n                    },\n                    {\n                        name: 'Major',\n                        count: _.defaultTo(counts['MAJOR'], 0),\n                        color: '#E3692F',\n                    },\n                    {\n                        name: 'Critical',\n                        count: _.defaultTo(counts['CRITICAL'], 0),\n                        color: '#DB4345',\n                    },\n\n                ];\n                break;\n            }\n        }\n\n        this.render();\n    }\n\n    onDataError() {\n        this.series = [];\n        this.render();\n    }\n\n    onRender() {\n        let height = this.ctrl.height || this.ctrl.panel.height || (this.ctrl.row && this.ctrl.row.height);\n        if (_.isString(height)) {\n            height = parseInt(height.replace('px', ''), 10);\n        }\n\n        if (this.elem.width() === 0 || height === 0 || height === undefined) {\n            if (this._renderRetries > this.retryTimes) {\n                console.log('onRender: still unable to determine height, and we ran out of retries');\n                return false;\n            }\n            this._renderRetries++;\n\n            console.log('onRender: unable to determine height, retrying again in ' + this.retryDelay + 'ms');\n            this.$timeout(() => {\n                this.onRender();\n            }, this.retryDelay);\n            return true;\n        }\n\n        height -= 5; // padding\n        height -= this.ctrl.panel.title ? 24 : 9; // subtract panel title bar\n\n        this.elem.css('height', height + 'px');\n\n        // Draw graph\n        switch (this.panel.direction) {\n            case 'horizontal':\n                $.plot(this.elem,\n                    _.map(this.series, function (serie) {\n                        return {\n                            data: [[serie.count, serie.name]],\n                            color: serie.color,\n                        };\n                    }),\n                    {\n                        series: {\n                            bars: {\n                                show: true,\n                                barWidth: 0.6,\n                                align: \"center\",\n                                fill: 0.8,\n                                lineWidth: 1.0,\n                                horizontal: true,\n                            }\n                        },\n                        yaxis: {\n                            mode: \"categories\",\n                            tickLength: 0,\n                            autoscaleMargin: .02,\n                        },\n                        grid: {\n                            borderWidth: 0,\n                        },\n                    });\n                break;\n\n            case 'vertical':\n                $.plot(this.elem,\n                    _.map(this.series, function (serie) {\n                        return {\n                            data: [[serie.name, serie.count]],\n                            color: serie.color,\n                        };\n                    }),\n                    {\n                        series: {\n                            bars: {\n                                show: true,\n                                barWidth: 0.5,\n                                align: \"center\",\n                                fill: 0.8,\n                                lineWidth: 1.0,\n                                horizontal: false,\n                            }\n                        },\n                        xaxis: {\n                            mode: \"categories\",\n                            tickLength: 0,\n                            autoscaleMargin: .02,\n                        },\n                        grid: {\n                            borderWidth: 0,\n                        },\n                    });\n                break;\n        }\n    }\n\n    query(data, column) {\n        // TODO: Make this a generator to save memory\n        let result = [];\n\n        for (let i = 0; i < data.length; i++) {\n            const columnIndex = _.findIndex(data[i].columns, {text: column});\n            const rows = data[i] && data[i].rows ? data[i].rows : [];\n            for (let j = 0; j < rows.length; j++) {\n                result.push(data[i].rows[j][columnIndex]);\n            }\n        }\n\n        return result;\n    }\n}\n\nAlarmHistogramCtrl.templateUrl = 'panels/alarm-histogram/module.html';\n\nexport {\n    AlarmHistogramCtrl\n};\n"]}