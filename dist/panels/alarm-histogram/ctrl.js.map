{"version":3,"sources":["../../../src/panels/alarm-histogram/ctrl.js"],"names":["MetricsPanelCtrl","_","AlarmHistogramCtrl","$scope","$injector","scope","defaults","panel","groupProperty","direction","events","on","onInitEditMode","bind","onDataReceived","onDataError","onRender","elem","attrs","ctrl","find","addEditorTab","data","counts","countBy","query","isNil","series","name","count","defaultTo","color","$root","colors","render","width","height","row","isString","parseInt","replace","title","css","$","plot","map","serie","bars","show","barWidth","align","fill","lineWidth","horizontal","yaxis","mode","tickLength","autoscaleMargin","grid","borderWidth","xaxis","column","result","i","length","columnIndex","findIndex","columns","text","j","rows","push","templateUrl"],"mappings":"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","file":"ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from \"app/plugins/sdk\";\nimport _ from \"lodash\";\nimport \"jquery.flot\";\nimport \"jquery.flot.selection\";\nimport \"jquery.flot.crosshair\";\nimport \"../../jquery.flot.categories\";\n\n\nclass AlarmHistogramCtrl extends MetricsPanelCtrl {\n\n    constructor($scope, $injector) {\n        super($scope, $injector);\n\n        this.scope = $scope;\n\n        _.defaults(this.panel, {\n            groupProperty: 'acknowledged',\n            direction: 'horizontal',\n        });\n\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n        this.events.on('data-received', this.onDataReceived.bind(this));\n        this.events.on('data-error', this.onDataError.bind(this));\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n        this.events.on('render', this.onRender.bind(this));\n    }\n\n    link($scope, elem, attrs, ctrl) {\n        this.elem = elem.find('.histogram-chart');\n        this.ctrl = ctrl;\n    }\n\n    onInitEditMode() {\n        this.addEditorTab('Grouping', 'public/plugins/opennms-helm-app/panels/alarm-histogram/editor.html', 2);\n    }\n\n    onDataReceived(data) {\n        switch (this.panel.groupProperty) {\n            case 'acknowledged': {\n                const counts = _.countBy(this.query(data, 'Acked By'), _.isNil);\n                this.series = [\n                    {\n                        name: 'Outstanding',\n                        count: _.defaultTo(counts[true], 0),\n                        color: this.scope.$root.colors[0],\n                    },\n                    {\n                        name: 'Acknowledged',\n                        count: _.defaultTo(counts[false], 0),\n                        color: this.scope.$root.colors[4],\n                    },\n                ];\n                break;\n            }\n\n            case 'severity': {\n                const counts = _.countBy(this.query(data, 'Severity'));\n                this.series = [\n                    {\n                        name: 'Cleared',\n                        count: _.defaultTo(counts['CLEARED'], 0),\n                        color: '#EEE000',\n                    },\n                    {\n                        name: 'Normal',\n                        count: _.defaultTo(counts['NORMAL'], 0),\n                        color: '#86B15B',\n                    },\n                    {\n                        name: 'Indeterm.',\n                        count: _.defaultTo(counts['INDETERMINATE'], 0),\n                        color: '#990000',\n                    },\n                    {\n                        name: 'Warning',\n                        count: _.defaultTo(counts['WARNING'], 0),\n                        color: '#FCCC3B',\n                    },\n                    {\n                        name: 'Minor',\n                        count: _.defaultTo(counts['MINOR'], 0),\n                        color: '#EE901C',\n                    },\n                    {\n                        name: 'Major',\n                        count: _.defaultTo(counts['MAJOR'], 0),\n                        color: '#E3692F',\n                    },\n                    {\n                        name: 'Critical',\n                        count: _.defaultTo(counts['CRITICAL'], 0),\n                        color: '#DB4345',\n                    },\n\n                ];\n                break;\n            }\n        }\n\n        this.render();\n    }\n\n    onDataError() {\n        this.series = [];\n        this.render();\n    }\n\n    onRender() {\n        // Size handling\n        if (this.elem.width() === 0) {\n            return true;\n        }\n\n        let height = this.ctrl.height || this.ctrl.panel.height || this.ctrl.row.height;\n        if (_.isString(height)) {\n            height = parseInt(height.replace('px', ''), 10);\n        }\n        height -= 5; // padding\n        height -= this.ctrl.panel.title ? 24 : 9; // subtract panel title bar\n\n        this.elem.css('height', height + 'px');\n\n        // Draw graph\n        switch (this.panel.direction) {\n            case 'horizontal':\n                $.plot(this.elem,\n                    _.map(this.series, function (serie) {\n                        return {\n                            data: [[serie.count, serie.name]],\n                            color: serie.color,\n                        };\n                    }),\n                    {\n                        series: {\n                            bars: {\n                                show: true,\n                                barWidth: 0.6,\n                                align: \"center\",\n                                fill: 0.8,\n                                lineWidth: 1.0,\n                                horizontal: true,\n                            }\n                        },\n                        yaxis: {\n                            mode: \"categories\",\n                            tickLength: 0,\n                            autoscaleMargin: .02,\n                        },\n                        grid: {\n                            borderWidth: 0,\n                        },\n                    });\n                break;\n\n            case 'vertical':\n                $.plot(this.elem,\n                    _.map(this.series, function (serie) {\n                        return {\n                            data: [[serie.name, serie.count]],\n                            color: serie.color,\n                        };\n                    }),\n                    {\n                        series: {\n                            bars: {\n                                show: true,\n                                barWidth: 0.5,\n                                align: \"center\",\n                                fill: 0.8,\n                                lineWidth: 1.0,\n                                horizontal: false,\n                            }\n                        },\n                        xaxis: {\n                            mode: \"categories\",\n                            tickLength: 0,\n                            autoscaleMargin: .02,\n                        },\n                        grid: {\n                            borderWidth: 0,\n                        },\n                    });\n                break;\n        }\n    }\n\n    query(data, column) {\n        // TODO: Make this a generator to save memory\n        let result = [];\n\n        for (let i = 0; i < data.length; i++) {\n            let columnIndex = _.findIndex(data[i].columns, {text: column});\n            for (let j = 0; j < data[i].rows.length; j++) {\n                result.push(data[i].rows[j][columnIndex]);\n            }\n        }\n\n        return result;\n    }\n}\n\nAlarmHistogramCtrl.templateUrl = 'panels/alarm-histogram/module.html';\n\nexport {\n    AlarmHistogramCtrl\n};\n"]}