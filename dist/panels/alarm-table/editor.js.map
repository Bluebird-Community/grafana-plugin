{"version":3,"sources":["../../../src/panels/alarm-table/editor.js"],"names":["tablePanelEditor","$q","uiSegmentSrv","restrict","scope","templateUrl","controller","TablePanelEditorCtrl","_","$","moment","angular","transformers","kbn","$scope","editor","panelCtrl","ctrl","panel","fontSizes","srcIndex","undefined","destIndex","addColumnSegment","newPlusButton","document","querySelectorAll","e","addEventListener","evt","handleEvent","classes","c","cols","forEach","call","col","classList","remove","srcElement","offsetParent","target","id","contains","parent","type","getTarget","add","dataTransfer","effectAllowed","setData","innerHTML","error","parseInt","replace","console","log","columns","text","preventDefault","dropEffect","columnIndex","removeClasses","screenX","screenY","eval","stopPropagation","$apply","splice","render","targetIndex","dataRaw","when","transform","getColumns","self","filter","a","indexOf","segments","map","newSegment","value","column","find","push","plusButton","html","without"],"mappings":"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","file":"editor.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport angular from 'angular';\n\nimport {transformers} from './transformers';\nimport kbn from 'app/core/utils/kbn';\n\nexport class TablePanelEditorCtrl {\n  /** @ngInject */\n  constructor($scope, $q, uiSegmentSrv) {\n    this.$q = $q;\n    this.$scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv;\n    $scope.editor = this;\n    this.panelCtrl = $scope.ctrl;\n    this.panel = this.panelCtrl.panel;\n    this.transformers = transformers;\n    this.fontSizes = ['80%', '90%', '100%', '110%', '120%', '130%', '150%', '160%', '180%', '200%', '220%', '250%'];\n\n    this.srcIndex = undefined;\n    this.destIndex = undefined;\n\n    this.addColumnSegment = uiSegmentSrv.newPlusButton();\n    let editor = document.querySelectorAll('.editor-row')[0];\n    for (const e of [ 'dragstart', 'dragover', 'dragleave', 'drop']) {\n      //console.log('adding listener: ' + e);\n      editor.addEventListener(e, (evt) => { this.handleEvent(e, evt); }, false);\n    }\n  }\n\n  removeClasses(...classes) {\n    for (const c of classes) {\n      const cols = document.querySelectorAll('.' + c);\n      [].forEach.call(cols, (col) => {\n        col.classList.remove(c);\n      });\n    }\n  }\n\n  getTarget(evt) {\n    if (evt.srcElement && evt.srcElement.offsetParent) {\n      let target = evt.srcElement.offsetParent;\n      if (target && target.id && target.classList && target.classList.contains('column-reorder')) {\n        return target;\n      }\n    }\n    // dragleave is only fired for the label and not the parent container\n    if (evt.target && evt.target.parent && evt.target.parent.classList && evt.target.parent.classList.contains('column-reorder')) {\n      return evt.target.parent;\n    }\n  }\n\n  handleEvent(type, evt) {\n    const target = this.getTarget(evt);\n    const id = evt.srcElement.id;\n\n    switch(type) {\n      case 'dragstart':\n        evt.srcElement.classList.add('picked-up');\n        evt.dataTransfer.effectAllowed = 'move';\n        // Internet Explorer doesn't support \"text/html\":\n        // https://stackoverflow.com/a/28740710\n        try {\n          evt.dataTransfer.setData('text/html', evt.srcElement.innerHTML);\n        } catch (error) {\n          evt.dataTransfer.setData('text', evt.srcElement.innerHTML);\n        }\n        if (id) {\n          this.srcIndex = parseInt(id.replace(/^column-/, ''), 10);\n          console.log('picking up \"' + this.panel.columns[this.srcIndex].text + '\"');\n        }\n        break;\n      case 'dragover':\n        if (evt.preventDefault) {\n          evt.preventDefault();\n        }\n        evt.dataTransfer.dropEffect = 'move';\n        if (target && target.id && target.classList && target.classList.contains('column-reorder')) {\n          const columnIndex = parseInt(target.id.replace(/^column-/, ''), 10);\n          if (!target.classList.contains('over')) {\n            //console.log('entering ' + this.panel.columns[columnIndex].text);\n            this.removeClasses('over');\n            target.classList.add('over');\n            this.destIndex = columnIndex;\n          }\n        }\n        break;\n      case 'dragleave':\n        if (target && evt.screenX !== 0 && evt.screenY !== 0) {\n          const columnIndex = parseInt(target.id.replace(/^column-/, ''), 10);\n          //console.log('leaving ' + this.panel.columns[columnIndex].text);\n          this.destIndex = undefined;\n          this.removeClasses('over');\n        }\n        break;\n      case 'drop':\n        if (eval.stopPropagation) {\n          evt.stopPropagation();\n        }\n        if (this.srcIndex !== undefined && this.destIndex !== undefined) {\n          this.$scope.$apply(() => {\n            this.panel.columns.splice(this.destIndex, 0, this.panel.columns.splice(this.srcIndex, 1)[0]);\n            this.panelCtrl.render();\n          });\n          console.log('dropped \"' + this.panel.columns[this.srcIndex].text + '\" onto \"' + this.panel.columns[this.destIndex].text + '\"');\n        } else {\n          const targetIndex = (this.srcIndex == undefined) ? 'source' : 'destination';\n          console.log(`WARNING: drop event received but ${targetIndex} was unset.`);\n        }\n        this.removeClasses('over', 'picked-up');\n        return false;\n        break;\n      default:\n        console.log('WARNING: unhandled event type: ' + type);\n    }\n  }\n\n  getColumnOptions() {\n    if (!this.panelCtrl.dataRaw) {\n      return this.$q.when([]);\n    }\n    let columns = this.transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw);\n    // Filter out columns that have already been selected\n    let self = this;\n    columns = columns.filter(function(a){return self.panel.columns.indexOf(a) < 0});\n    let segments = _.map(columns, (c) => this.uiSegmentSrv.newSegment({value: c.text}));\n    return this.$q.when(segments);\n  }\n\n  addColumn() {\n    let columns = transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw);\n    let column = _.find(columns, {text: this.addColumnSegment.value});\n\n    if (column) {\n      this.panel.columns.push(column);\n      this.render();\n    }\n\n    let plusButton = this.uiSegmentSrv.newPlusButton();\n    this.addColumnSegment.html = plusButton.html;\n    this.addColumnSegment.value = plusButton.value;\n  }\n\n  transformChanged() {\n    this.panel.columns = [];\n    if (this.panel.transform === 'timeseries_aggregations') {\n      this.panel.columns.push({text: 'Avg', value: 'avg'});\n    }\n\n    this.render();\n  }\n\n  render() {\n    this.panelCtrl.render();\n  }\n\n  removeColumn(column) {\n    this.panel.columns = _.without(this.panel.columns, column);\n    this.panelCtrl.render();\n  }\n}\n\n/** @ngInject */\nexport function tablePanelEditor($q, uiSegmentSrv) {\n  'use strict';\n  return {\n    restrict: 'E',\n    scope: true,\n    templateUrl: '/public/plugins/opennms-helm-app/panels/alarm-table/editor.html',\n    controller: TablePanelEditorCtrl,\n  };\n}\n"]}