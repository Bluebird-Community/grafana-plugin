{"version":3,"sources":["../../../src/panels/alarm-table/memo_editor.js"],"names":["memoEditorAsDirective","restrict","templateUrl","controller","MemoEditorCtrl","scope","alarm","source","type","$scope","datasourceSrv","timeSrv","alarmId","id","setupWithAlarm","self","$watch","memoChanged","didMemoChange","saveMemo","actionInProgress","getDatasource","then","ds","saveSticky","memoBody","saveJournal","refresh","catch","console","warn","err","deleteMemo","deleteSticky","deleteJournal","get","indexOf","message","getAlarm","refreshDashboard","memo","body","originalMemoBody"],"mappings":"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","file":"memo_editor.js","sourcesContent":["export class MemoEditorCtrl {\n  /** @ngInject */\n  constructor($scope, datasourceSrv, timeSrv) {\n    this.$scope = $scope;\n    this.datasourceSrv = datasourceSrv;\n    this.timeSrv = timeSrv;\n\n    // Require a valid type\n    if ($scope.type !== 'journal' && $scope.type !== 'sticky') {\n      throw \"Unsupported memo type\" + $scope.type;\n    }\n\n    // Save the id, this won't change during the lifetime of this controller\n    $scope.alarmId = $scope.alarm.id;\n    this.setupWithAlarm($scope.alarm);\n\n    // Register a listener for the memo body so that we can enable the Save button\n    // when the form is 'dirty'\n    let self = this;\n    $scope.$watch('memoBody', function() {\n      $scope.memoChanged = self.didMemoChange();\n    });\n\n    $scope.saveMemo = function() {\n      $scope.actionInProgress = true;\n      self.getDatasource().then(ds => {\n        if ($scope.type === 'sticky') {\n          return ds.saveSticky($scope.alarm.id, $scope.memoBody);\n        } else {\n          return ds.saveJournal($scope.alarm.id, $scope.memoBody);\n        }\n      })\n      .then(() => {\n        $scope.actionInProgress = false;\n        self.refresh();\n      })\n      .catch(err => {\n        $scope.actionInProgress = false;\n        console.warn('Failed to save memo.', err);\n        self.refresh();\n      })\n    };\n\n    $scope.deleteMemo = function() {\n      $scope.actionInProgress = true;\n      self.getDatasource().then(ds => {\n        if ($scope.type === 'sticky') {\n          return ds.deleteSticky($scope.alarm.id);\n        } else {\n          return ds.deleteJournal($scope.alarm.id);\n        }\n      })\n      .then(() => {\n        $scope.actionInProgress = false;\n        self.refresh();\n      })\n      .catch(err => {\n        $scope.actionInProgress = false;\n        console.warn('Failed to delete memo.', err);\n        self.refresh();\n      });\n    };\n  }\n\n  getDatasource() {\n    return this.datasourceSrv.get(this.$scope.source).then(ds => {\n      if (ds.type && ds.type.indexOf(\"fault-datasource\") < 0) {\n        throw {message: 'Only OpenNMS datasources are supported'};\n      } else {\n        return ds;\n      }\n    });\n  }\n\n  refresh() {\n    let self = this;\n    this.getDatasource().then(ds => {return ds.getAlarm(self.$scope.alarmId)})\n      .then(alarm => {\n        self.setupWithAlarm(alarm)\n      });\n    // Refresh the dashboard\n    self.timeSrv.refreshDashboard();\n  }\n\n  setupWithAlarm(alarm) {\n    this.$scope.alarm = alarm;\n    this.$scope.memo = this.$scope.alarm[this.$scope.type];\n    this.$scope.memoBody = this.$scope.memo ? this.$scope.memo.body : null;\n    this.$scope.memoChanged = false;\n  }\n\n  didMemoChange() {\n    let originalMemoBody = null;\n    if (this.$scope.memo) {\n      originalMemoBody = this.$scope.memo.body;\n    }\n    return originalMemoBody !== this.$scope.memoBody;\n  }\n}\n\n/** @ngInject */\nexport function memoEditorAsDirective() {\n  'use strict';\n  return {\n    restrict: 'E',\n    templateUrl: 'public/plugins/opennms-helm-app/panels/alarm-table/memo_editor.html',\n    controller: MemoEditorCtrl,\n    scope: {\n      alarm: '=',\n      source: '=',\n      type: '@',\n    }\n  };\n}\n"]}