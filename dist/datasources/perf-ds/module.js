/*! For license information please see module.js.LICENSE.txt */
define(["lodash","@grafana/data","app/plugins/sdk"],(function(e,t,r){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=51)}({0:function(t,r){t.exports=e},10:function(e,t,r){"use strict";r.d(t,"a",(function(){return c}));var n=r(2),o=r(17),a=r.n(o),i=/\s*,\s*/,u=function(e){return"string"==typeof e||e instanceof String},s=function(e){if(e&&Array.isArray(e)&&e.length>0)return e[e.length-1]},c=function(){function e(){}return e.parenthesize=function(t){return e._process(a()(t,{brackets:["()"]}))},e.parenthesizeWithArguments=function(t){return e.parenthesize(t).map((function(t){return t&&t.arguments&&t.arguments.length<2&&(t.arguments=e.getArguments(t.arguments[0])),t}))},e.findFunctions=function(t){return e.parenthesizeWithArguments(t).filter((function(e){return e&&void 0!==e.name}))},e.getArguments=function(e){var t=null==e?"":e;if(0===t.length)return[];var r=t.split(i);return Array.isArray(r)?r:[r]},e.replace=function(t,r){var n=e.parenthesizeWithArguments(t),o="";return n.forEach((function(e){u(e)?o+=e:e.name&&(r&&r.hasOwnProperty(e.name)?o+=r[e.name].apply(r[e.name],e.arguments):(o+=e.name+"(",e.arguments&&(o+=e.arguments.join(", ")),o+=")"))})),o},e.format=function(t,r){return e.replace(t,{nodeToLabel:function(t){var n=e._getNodeFromCriteria(r,t);return n?n.label:t},resourceToLabel:function(t,n){var o=e._getResource(r,t,n);return o?o.label:n?[t,n].join("."):t},resourceToName:function(t,n){var o=e._getResource(r,t,n);return o?o.name:n?[t,n].join("."):t},resourceToInterface:function(t,n){var o=e._getResource(r,t,n);if(o){var a=o.name.match(/^(\w+)/);if(a||(a=o.label.match(/^(\w+)/)),a)return a[1]}return n?[t,n].join("."):t}})},e._process=function(t){var r=[],n=/^(.*?)(\w+?)\($/,o=!1;return t.forEach((function(a,i){if(o)o=!1;else{var s,c=r.length?r[r.length-1]:void 0,l=t[i+1];if(Array.isArray(a))r.push(e._process(a));else if(null!==(s=n.exec(a))){var f=s[1];f&&f.length>0&&(f.startsWith(")")&&c&&c.name&&(f=f.replace(/^\)/,"")),r.push(f)),r.push({name:s[2],arguments:e._process(l)}),o=!0}else if(u(a)&&a.startsWith(")")&&c&&c.name){var p=a.replace(/^\)/,"");p.length>0&&r.push(p)}else r.push(a)}})),e._flatten(r)},e._flatten=function(t){var r=[];return t.forEach((function(t){if(u(t)){if(0===t.length)return;var n=s(r);u(n)?r[r.length-1]+=t:r.push(t)}else if(t&&t.arguments)t.arguments=e._flatten(t.arguments),r.push(t);else{if(!Array.isArray(t))throw new Error("cannot reach here (args)");e._flatten(t).forEach((function(e){var t=s(r);if(u(e)){if(0===e.trim().length)return;u(t)?r[r.length-1]+=e:r.push(e)}else{if(!e||!e.arguments)throw new Error("cannot reach here (result)");r.push(e)}}))}})),r},e._getNodeFromCriteria=function(t,r){var o,a,i,u;return r&&r.indexOf(":")>0?(i=(o=Object(n.e)(r.split(":"),2))[0],u=o[1]):a=parseInt(r,10),e._getNodeFromMetadata(t,a,i,u)},e._getNodeFromMetadata=function(e,t,r,n){if(e&&e.nodes){var o=e.nodes.filter((function(e){return void 0!==t&&e.id===t||void 0!==r&&void 0!==n&&e["foreign-source"]===r&&e["foreign-id"]===n}))[0];if(void 0!==o)return o}return null},e._getResource=function(t,r,o){var a,i;if(void 0===o)try{for(var u=Object(n.g)(t.resources),s=u.next();!s.done;s=u.next()){if((c=s.value).id===r)return c}}catch(e){a={error:e}}finally{try{s&&!s.done&&(i=u.return)&&i.call(u)}finally{if(a)throw a.error}}else{var c,l=e._getNodeFromCriteria(t,r);if(l)if(c=e._getResourceFromCriteria(t,o,"node["+l["foreign-source"]+":"+l["foreign-id"]+"]","node["+l.id+"]"))return c}return null},e._getResourceFromCriteria=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];if(e&&e.resources){var a=e.resources.filter((function(e){var o,a;if(e.id===t)return!0;try{for(var i=Object(n.g)(r.map((function(e){return e+"."+t}))),u=i.next();!u.done;u=i.next()){var s=u.value;if(e.id===s)return!0}}catch(e){o={error:e}}finally{try{u&&!u.done&&(a=i.return)&&a.call(i)}finally{if(o)throw o.error}}return!1}))[0];if(void 0!==a)return a}return null},e}()},17:function(e,t,r){"use strict";function n(e,t){if("string"!=typeof e)return[e];var r=[e];"string"==typeof t||Array.isArray(t)?t={brackets:t}:t||(t={});var n=t.brackets?Array.isArray(t.brackets)?t.brackets:[t.brackets]:["{}","[]","()"],o=t.escape||"___",a=!!t.flat;n.forEach((function(e){var t=new RegExp(["\\",e[0],"[^\\",e[0],"\\",e[1],"]*\\",e[1]].join("")),n=[];function a(t,a,i){var u=r.push(t.slice(e[0].length,-e[1].length))-1;return n.push(u),o+u+o}r.forEach((function(e,n){for(var o,i=0;e!=o;)if(o=e,e=e.replace(t,a),i++>1e4)throw Error("References have circular dependency. Please, check them.");r[n]=e})),n=n.reverse(),r=r.map((function(t){return n.forEach((function(r){t=t.replace(new RegExp("(\\"+o+r+"\\"+o+")","g"),e[0]+"$1"+e[1])})),t}))}));var i=new RegExp("\\"+o+"([0-9]+)\\"+o);return a?r:function e(t,r,n){for(var o,a=[],u=0;o=i.exec(t);){if(u++>1e4)throw Error("Circular references in parenthesis");a.push(t.slice(0,o.index)),a.push(e(r[o[1]],r)),t=t.slice(o.index+o[0].length)}return a.push(t),a}(r[0],r)}function o(e,t){if(t&&t.flat){var r,n=t&&t.escape||"___",o=e[0];if(!o)return"";for(var a=new RegExp("\\"+n+"([0-9]+)\\"+n),i=0;o!=r;){if(i++>1e4)throw Error("Circular references in "+e);r=o,o=o.replace(a,u)}return o}return e.reduce((function e(t,r){return Array.isArray(r)&&(r=r.reduce(e,"")),t+r}),"");function u(t,r){if(null==e[r])throw Error("Reference "+r+"is undefined");return e[r]}}function a(e,t){return Array.isArray(e)?o(e,t):n(e,t)}a.parse=n,a.stringify=o,e.exports=a},2:function(e,t,r){"use strict";r.d(t,"c",(function(){return o})),r.d(t,"a",(function(){return a})),r.d(t,"b",(function(){return i})),r.d(t,"d",(function(){return u})),r.d(t,"g",(function(){return s})),r.d(t,"e",(function(){return c})),r.d(t,"f",(function(){return l}));var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var a=function(){return(a=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function i(e,t,r,n){return new(r||(r=Promise))((function(o,a){function i(e){try{s(n.next(e))}catch(e){a(e)}}function u(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}s((n=n.apply(e,t||[])).next())}))}function u(e,t){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}Object.create;function s(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function c(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,a=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return i}function l(e,t,r){if(r||2===arguments.length)for(var n,o=0,a=t.length;o<a;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}Object.create},23:function(e,t,r){"use strict";var n=function(){this.patterns={timeout:/^\d+$/},this.current&&(this.current.jsonData||(this.current.jsonData={}),this.current.jsonData.timeout||(this.current.jsonData.timeout=10))};"undefined"!=typeof angular&&(angular.injector().has("onmstimeoutSettingsDirective")||angular.module("grafana.directives").directive("onmsTimeoutSettings",(function(){return{templateUrl:"public/plugins/opennms-helm-app/components/timeout.html",restrict:"E",controller:"OnmsTimeoutCtrl",controllerAs:"ctrl",bindToController:!0,scope:{current:"="}}})).controller("OnmsTimeoutCtrl",n))},3:function(e,r){e.exports=t},37:function(e,t,r){"use strict";var n=function(){function e(e){this.$scope=e,this.query="",this.offset=0,this.selectedRow=null,this.currentPage=0,this.pageSize=25,this.selfPagination=!1,this.allResult=[],this.rows=[],this.searching=!1,this.count=0,this.totalCount=0,this.numberOfPages=0,this.searchForRows(),$('[name="perf-modal-query"]').select()}return e.$inject=["$scope"],e.prototype.searchForRows=function(){var e=this;this.searching=!0,this.$scope.search(this.query,this.offset).then((function(t){e.selectedRow=null,e.allResult=t.rows,t.rows.length>e.pageSize?(e.selfPagination=!0,e.count=0,e.updateSelfPageinatedData()):(e.rows=t.rows,e.count=(t.count?t.count:e.rows.length)+e.offset),e.totalCount=t.totalCount,e.numberOfPages=Math.ceil(e.totalCount/e.pageSize)})).finally((function(){e.$scope.$evalAsync((function(){e.searching=!1}))}))},e.prototype.updateSelfPageinatedData=function(){this.rows=this.allResult.slice(this.offset,this.offset+this.pageSize),this.count+=this.rows.length},e.prototype.startFrom=function(e,t){return e*t},e.prototype.setClickedRow=function(e){this.selectedRow===e?this.selectedRow=null:(this.selectedRow=e,this.row=this.rows[this.selectedRow])},e.prototype.nextPage=function(){this.currentPage+1!==this.$scope.ctrl.numberOfPages&&(this.offset+=this.pageSize,this.currentPage++,this.selfPagination?this.updateSelfPageinatedData():this.searchForRows())},e.prototype.prevPage=function(){0!==this.currentPage&&(this.offset-=this.pageSize,this.currentPage--,this.searchForRows())},e.prototype.cancel=function(){this.$scope.result.reject(),this.$scope.dismiss()},e.prototype.ok=function(){null!==this.selectedRow?this.$scope.result.resolve(this.row):this.$scope.result.reject(),this.$scope.dismiss()},e}();"undefined"!=typeof angular&&angular.module("grafana.controllers").controller("OpenNMSModalSelectionCtrl",n)},51:function(e,t,r){"use strict";r.r(t);var n=r(2),o=Object.freeze({Attribute:"attribute",Expression:"expression",Filter:"filter","String Property":"stringProperty"}),a=r(0),i=r.n(a);function u(e,t){return!i.a.isNull(e)&&!i.a.isEmpty(e)&&e.indexOf("$"+t)>=0}function s(e,t){if(i.a.isNull(e)||i.a.isEmpty(e))return e;var r=e;return i.a.each(t,(function(e){var t="\\$"+e.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");r=r.replace(new RegExp(t,"g"),e.value)})),r}function c(e,t,r,n,o,a){void 0===n&&(n=function(){}),void 0===o&&(o=u),void 0===a&&(a=s);var c=i.a.clone(r);c.push({name:"index",value:[0]});var l=[];if(i.a.each(c,(function(r){i.a.find(t,(function(t){return o(e[t],r.name)}))&&l.push(r)})),l.length<1)return n(e),[e];var f=function(e){var t=[];i.a.each(e,(function(e){t.push(e.value)}));var r,n,o,a=(n=[],o=(r=t).length-1,function e(t,a){for(var i=0,u=r[a].length;i<u;i++){var s=t.slice(0);s.push(r[a][i]),a===o?n.push(s):e(s,a+1)}}([],0),n),u=[];return i.a.each(a,(function(t){for(var r=[],n=0,o=e.length;n<o;n++){var a=JSON.parse(JSON.stringify(e[n]));a.value=t[n],r.push(a)}u.push(r)})),u}(l),p=[],d=0;return i.a.each(f,(function(r){i.a.each(r,(function(e){"index"===e.name&&(e.value="idx"+d,d+=1)}));var o=i.a.clone(e);i.a.each(t,(function(e){o[e]=a(o[e],r)})),n(o),p.push(o)})),p}var l=r(10),f=r(3);function p(e){return void 0!==e&&!!e.nodeId&&!!e.resourceId&&!!e.stringProperty}var d=function(){function e(e,t,r,n){this.$q=t,this.backendSrv=r,this.templateSrv=n,this.withCredentials=!1,this.timeout=1e4,this.searchLimit=25,this.type=e.type,this.url=e.url,this.name=e.name,this.interval=(e.jsonData||{}).timeInterval,e.jsonData&&e.jsonData.timeout&&(this.timeout=1e3*parseInt(e.jsonData.timeout,10))}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv"],e.prototype.doOpenNMSRequest=function(e){return(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers=e.headers||{},e.headers.Authorization=this.basicAuth),e.url=this.url+e.url,this.timeout&&(e.timeout=this.timeout),this.backendSrv.datasourceRequest(e)},e.prototype.decorateError=function(e){var t=e;e.err&&(t=e.err);var r=t.statusText||"Request failed.";return t.cancelled&&(delete t.cancelled,r="Request timed out."),e.cancelled&&(delete e.cancelled,r="Request timed out."),t.message||(t.message=r),t.status||(t.status="error"),this.$q.reject(t)},e.prototype.someQueriesAreStringPropertyQueries=function(e){return e.targets.some((function(e){return"stringProperty"===e.type}))},e.prototype.queryStringPropertiesOfNode=function(e,t){var r=this;return this.doOpenNMSRequest({url:"/rest/resources/fornode/"+encodeURIComponent(e),method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return t.flatMap((function(t){return e.data.children.resource.filter((function(e){return e.id.endsWith("."+t.resourceId)})).flatMap((function(n){return r.extractStringProperty(t,n,e.data)}))}))}))},e.prototype.extractStringProperty=function(e,t,r){return Object.keys(t.stringPropertyAttributes).filter((function(t){return t===e.stringProperty})).flatMap((function(n){return{refId:e.refId,fields:[{name:"nodeId",type:f.FieldType.string,config:{},values:[e.nodeId]},{name:"nodeLabel",type:f.FieldType.string,values:[r?r.label:e.nodeId]},{name:"resourceId",type:f.FieldType.string,config:{},values:[e.resourceId]},{name:"resourceLabel",type:f.FieldType.string,config:{},values:[t.label]},{name:n,type:f.FieldType.string,config:{},values:[t.stringPropertyAttributes[n]]}]}}))},e.prototype.queryStringProperties=function(e){var t=this,r=e.targets.filter((function(e){return!e.hide})).filter(p).map((function(e){return Object(n.a)(Object(n.a)({},e),{nodeId:t.templateSrv.replace(e.nodeId),resourceId:t.templateSrv.replace(e.resourceId)})})).reduce((function(e,t){return(e[t.nodeId]=e[t.nodeId]||[]).push(t),e}),{}),o=Object.keys(r).map((function(e){var n=r[e];return t.queryStringPropertiesOfNode(e,n)}));return Promise.all(o).then((function(e){return{data:e.flatMap((function(e){return e}))}}))},e.prototype.query=function(t){var r=t.targets.filter((function(e){return!e.hide&&e.type}));if(r.every((function(e){return"stringProperty"===e.type})))return this.queryStringProperties(t);if(r.some((function(e){return"stringProperty"===e.type})))return Promise.resolve({data:[],error:{message:"string property queries can not be mixed with other kinds of queries"}});var o=this,a=Object(n.e)(this.buildQuery(t),2),u=a[0],s=a[1];return!Array.isArray(u)&&u.source.length>0?this.doOpenNMSRequest({url:"/rest/measurements",data:u,method:"POST",headers:{"Content-Type":"application/json"}}).then((function(t){return t.status<200||t.status>=300?o.$q.reject(t):e.processMeasurementsResponse(t)})).then((function(e){return e.data=i.a.sortBy(e.data,(function(e){return i.a.indexOf(s,e.label)})),e})).catch((function(e){return o.$q.reject(o.decorateError(e))})):this.$q.when({data:[]})},e.prototype.testDatasource=function(){var e=this;return this.doOpenNMSRequest({url:"/rest/info",method:"GET"}).then((function(e){return 200===e.status?{status:"success",message:"Data source is working",title:"Success"}:{status:"danger",message:"OpenNMS provided a response, but no metadata was found.",title:"Unexpected Response "+e.status}})).catch((function(t){return e.decorateError(t)}))},e.prototype.metricFindQuery=function(e){var t,r;if(null==e||""===e)return this.$q.resolve([]);var o=i.a.first(this.interpolateValue(e));if(void 0!==o){var a=l.a.findFunctions(o);try{for(var u=Object(n.g)(a),s=u.next();!s.done;s=u.next()){var c=s.value;if("nodeFilter"===c.name)return this.metricFindNodeFilterQuery.apply(this,c.arguments);if("nodeResources"===c.name)return this.metricFindNodeResourceQuery.apply(this,c.arguments)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=u.return)&&r.call(u)}finally{if(t)throw t.error}}}return this.$q.resolve([])},e.prototype.metricFindNodeFilterQuery=function(e){return this.doOpenNMSRequest({url:"/rest/nodes",method:"GET",params:{filterRule:e,limit:0}}).then((function(e){e.data.count,e.data.totalCount;var t=[];return i.a.each(e.data.node,(function(e){var r=e.id.toString();null!==e.foreignId&&null!==e.foreignSource&&(r=e.foreignSource+":"+e.foreignId),t.push({text:e.label,value:r,expandable:!0})})),t}))},e.prototype.metricFindNodeResourceQuery=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var o="id",a="*";return r.length>0&&(o=r[0]),r.length>1&&(a=r[1]),this.doOpenNMSRequest({url:"/rest/resources/"+encodeURIComponent(e.getNodeResource(t)),method:"GET",params:{depth:1}}).then((function(e){var t=[];return i.a.each(e.data.children.resource,(function(e){var r,n=e.id.match(/node(Source)?\[.*?\]\.(.*)/);switch(o){case"id":r=n[2];break;case"label":r=e.label;break;case"name":r=e.name;break;default:r=n[2]}("*"===a&&n||0===n[2].indexOf(a+"["))&&t.push({text:r,value:n[2],expandable:!0})})),t}))},e.prototype.buildQuery=function(t){var r=t.maxDataPoints||300,n=t.intervalMs||6e4,a=this,u=t.range.from.valueOf(),s=t.range.to.valueOf(),c=Math.floor((s-u)/r),l={start:u,end:s,step:c=c<n?n:c,relaxed:!0,maxrows:r,source:[],expression:[]},f=[];return i.a.each(t.targets,(function(r){var n=!1;if(r.hide&&(n=!0),r.type===o.Attribute){if(!(r.nodeId&&r.resourceId&&r.attribute))return;var u=r.label;void 0!==u&&""!==u||(u=r.attribute);var s={aggregation:r.aggregation,attribute:r.attribute,label:u,resourceId:r.resourceId,nodeId:r.nodeId,transient:n,datasource:void 0};void 0!==r.subattribute&&""!==r.subattribute&&(s.datasource=r.subattribute),void 0!==r.fallbackAttribute&&""!==r.fallbackAttribute&&(s["fallback-attribute"]=r.fallbackAttribute),s=a.interpolateSourceVariables(s,t.scopedVars,(function(t){t.resourceId=e.getRemoteResourceId(t.nodeId,t.resourceId),delete t.nodeId})),l.source=l.source.concat(s),f=f.concat(i.a.map(s,"label"))}else if(r.type===o.Expression){if(!r.label||!r.expression)return;var c={label:r.label,value:r.expression,transient:n};c=a.interpolateExpressionVariables(c,t.scopedVars),l.expression=l.expression.concat(c),f=f.concat(i.a.map(c,"label"))}else if(r.type===o.Filter){if(!r.filter)return;var p=a.interpolateVariables(r.filterParameters,i.a.keys(r.filterParameters),t.scopedVars),d=i.a.map(p,(function(e){var t=[];return i.a.each(e,(function(e,r){void 0!==e&&""!==e&&null!==e&&t.push({key:r,value:e})})),{name:r.filter.name,parameter:t}}));l.filter?l.filter=l.filter.concat(d):l.filter=d}})),[l,f]},e.prototype.interpolateSourceVariables=function(e,t,r){return this.interpolateVariables(e,["nodeId","resourceId","attribute","datasource","label"],t,r)},e.prototype.interpolateExpressionVariables=function(e,t){return this.interpolateVariables(e,["value","label"],t)},e.prototype.interpolateValue=function(e,t){return i.a.map(this.interpolateVariables({value:e},["value"],t),(function(e){return e.value}))},e.prototype.interpolateVariables=function(e,t,r,n){var o=[];return i.a.each(this.templateSrv.variables,(function(e){var t={name:e.name,value:[]};r&&void 0!==r[t.name]?t.value.push(r[t.name].value):i.a.isString(e.current.value)?t.value.push(e.current.value):i.a.each(e.current.value,(function(r){"$__all"===r?i.a.each(e.options,(function(e){"$__all"!==e.value&&t.value.push(e.value)})):t.value.push(r)})),o.push(t)})),c(e,t,o,n)},e.processMeasurementsResponse=function(e){var t,r,n,o,a,i,u,s=e.data.labels,c=e.data.columns,f=e.data.timestamps,p=e.data.metadata,d=[];if(void 0!==f)for(n=f.length,o=c.length,t=0;t<o;t++){for(u=!1,a=[],r=0;r<n;r++)f[r]<e.data.start||f[r]>e.data.end||("NaN"===(i=c[t].values[r])&&(i=null),u||isNaN(i)||(u=!0),a.push([i,f[r]]));var h=s[t];p&&p.resources&&(h=l.a.format(h,p)),u&&d.push({target:h,label:s[t],datapoints:a})}return{data:d}},e.flattenResourcesWithAttributes=function(t,r){return i.a.each(t,(function(t){void 0!==t.rrdGraphAttributes&&Object.keys(t.rrdGraphAttributes).length>0&&r.push(t),void 0!==t.children&&t.children.resource.length>0&&e.flattenResourcesWithAttributes(t.children.resource,r)})),r},e.getNodeResource=function(e){return(e.indexOf(":")>0?"nodeSource[":"node[")+e+"]"},e.getRemoteResourceId=function(t,r){return e.getNodeResource(t)+"."+r},e.prototype.searchForNodes=function(e,t){return this.doOpenNMSRequest({url:"/rest/nodes",method:"GET",params:{offset:t,limit:this.searchLimit,match:"any",comparator:"ilike",orderBy:"id",order:"asc",label:"%"+e+"%",sysName:"%"+e+"%","ipInterface.ipAddress":"%"+e+"%","ipInterface.ipHostName":"%"+e+"%",foreignId:e+"%"}})},e.prototype.getResourcesWithAttributesForNode=function(t){var r=i.a.first(this.interpolateValue(t));return this.doOpenNMSRequest({url:"/rest/resources/fornode/"+encodeURIComponent(r),method:"GET",params:{depth:-1}}).then((function(t){return e.flattenResourcesWithAttributes([t.data],[])}))},e.prototype.getAvailableFilters=function(){return this.doOpenNMSRequest({url:"/rest/measurements/filters",method:"GET"})},e.prototype.suggestAttributes=function(t,r,n){var o=i.a.first(this.interpolateValue(t)),a=i.a.first(this.interpolateValue(r)),u=e.getRemoteResourceId(o,a);return this.doOpenNMSRequest({url:"/rest/resources/"+encodeURIComponent(u),method:"GET",params:{depth:-1}}).then((function(e){n=n.toLowerCase();var t=[];return i.a.each(e.data.rrdGraphAttributes,(function(e,r){r.toLowerCase().indexOf(n)>=0&&t.push(r)})),t.sort(),t}))},e.prototype.suggestStringProperties=function(t,r,n){var o=i.a.first(this.interpolateValue(t)),a=i.a.first(this.interpolateValue(r)),u=e.getRemoteResourceId(o,a);return this.doOpenNMSRequest({url:"/rest/resources/"+encodeURIComponent(u),method:"GET",params:{depth:-1}}).then((function(e){n=n.toLowerCase();var t=[];return i.a.each(e.data.stringPropertyAttributes,(function(e,r){r.toLowerCase().indexOf(n)>=0&&t.push(r)})),t.sort(),t}))},e}(),h=r(8),g=(r(37),function(e){function t(t,r,n,a,i){var u=e.call(this,a,i)||this;return u.$rootScope=t,u.$q=r,u.$modal=n,u.$scope=a,u.nodeResources=[],u.appEvents=new f.EventBusSrv,u.types=o,u.error=u.validateTarget(),u.target||(u.target={}),u}return t.$inject=["$rootScope","$q","$modal","$scope","$injector"],Object(n.c)(t,e),t.prototype.openNodeSelectionModal=function(){var e=this;this.showSelectionModal("nodes",{"#":"id",Label:"label","Foreign ID":"foreignId",sysName:"sysName"},(function(t,r){return e.datasource.searchForNodes(t,r).then((function(e){return{count:e.data.count,totalCount:e.data.totalCount,rows:e.data.node}}))}),(function(t){i.a.isUndefined(t.foreignId)||i.a.isNull(t.foreignId)||i.a.isUndefined(t.foreignSource)||i.a.isNull(t.foreignSource)?e.target.nodeId=t.id:e.target.nodeId=t.foreignSource+":"+t.foreignId,e.targetBlur("nodeId")}))},t.prototype.openResourceSelectionModal=function(){var e=this;function t(e,t){var r=e;return t.length>=1&&(t=t.toLowerCase(),r=i.a.filter(e,(function(e){return e.key.indexOf(t)>=0}))),{totalCount:r.length,rows:r}}e.nodeResources=void 0,this.showSelectionModal("resources",{Label:"label",Name:"name"},(function(r){if(void 0!==e.nodeResources){var n=e.$q.defer();return n.resolve(t(e.nodeResources,r)),n.promise}return e.datasource.getResourcesWithAttributesForNode(e.target.nodeId).then((function(n){return i.a.each(n,(function(e){e.key=e.label.toLowerCase()+e.name.toLowerCase()})),e.nodeResources=i.a.sortBy(n,(function(e){return e.label})),t(e.nodeResources,r)}))}),(function(t){var r=/node(Source)?\[.*?]\.(.*)$/.exec(t.id);e.target.resourceId=r?r[2]:void 0,e.targetBlur("resourceId")}))},t.prototype.openAttributeSelectionModal=function(e){var t=this;e||(e="attribute"),this.showSelectionModal("attributes",{Name:"name"},(function(e){return t.datasource.suggestAttributes(t.target.nodeId,t.target.resourceId,e).then((function(e){var t=[];return i.a.each(e,(function(e){t.push({name:e})})),{totalCount:t.length,rows:t}}))}),(function(r){t.target[e]=r.name,t.targetBlur(e)}))},t.prototype.openStringPropertySelectionModal=function(e){var t=this;e||(e="attribute"),this.showSelectionModal("attributes",{Name:"name"},(function(e){return t.datasource.suggestStringProperties(t.target.nodeId,t.target.resourceId,e).then((function(e){var t=e.map((function(e){return{name:e}}));return{totalCount:t.length,rows:t}}))}),(function(r){t.target[e]=r.name,t.targetBlur(e)}))},t.prototype.openFilterSelectionModal=function(){var e=this;this.showSelectionModal("filters",{Name:"name",Description:"description",Backend:"backend"},(function(){return e.datasource.getAvailableFilters().then((function(e){return{totalCount:e.data.length,rows:e.data}}))}),(function(t){e.target.filter=t,e.targetBlur("filter")}))},t.prototype.showSelectionModal=function(e,t,r,n){var o=this.$rootScope.$new();o.label=e,o.columns=t,o.search=r,o.result=this.$q.defer(),o.result.promise.then(n);var a=this.$modal({template:"public/plugins/opennms-helm-app/datasources/perf-ds/partials/modal.selection.html",persist:!1,show:!1,scope:o,keyboard:!1});return this.$q.when(a).then((function(e){return e.modal("show")}))},t.prototype.targetBlur=function(e,t){void 0===t&&(t=!0);var r=this.validateTarget(e,t);r?(this.appEvents.emit("alert-error",["Error",r]),this.error=r):this.refresh()},t.prototype.validateTarget=function(e,t){var r,n;if(this.target.type===o.Attribute||this.target.type===o.Expression){var a={nodeId:"You must supply a node id.",resourceId:"You must supply a resource id.",attribute:"You must supply an attribute.",expression:"You must supply an expression.",label:"You must supply a label."};if(t&&e&&e in a&&!this.target[e])return a[e];if(t&&e&&!this.target[e])return e+" is a required field."}else if(this.target.type===o.Filter)if("filterName"===e){if(!this.target.filter||this.target.filter&&(!this.target.filter.name||0===this.target.filter.name.trim().length))return"You must select a filter."}else if(e&&"type"!==e&&t&&(!this.target.filterParameters||!(e in(null===(r=this.target)||void 0===r?void 0:r.filterParameters))||!(null===(n=this.target)||void 0===n?void 0:n.filterParameters[e])))return e+" is a required field.";return null},t.prototype.getCollapsedText=function(){return this.target.type===o.Attribute?"Attribute: "+this.target.attribute:this.target.type===o.Expression?"Expression: "+this.target.label:this.target.type===o.Filter?"Filter: "+this.target.filter.name:"<Incomplete>"},t.templateUrl="public/plugins/opennms-helm-app/datasources/perf-ds/partials/query.editor.html",t}(h.QueryCtrl));r(23);r.d(t,"ConfigCtrl",(function(){return m})),r.d(t,"QueryOptionsCtrl",(function(){return v})),r.d(t,"Datasource",(function(){return d})),r.d(t,"QueryCtrl",(function(){return g}));var m=function(){function e(){}return e.templateUrl="public/plugins/opennms-helm-app/datasources/perf-ds/partials/config.html",e}(),v=function(){function e(){}return e.templateUrl="public/plugins/opennms-helm-app/datasources/perf-ds/partials/query.options.html",e}()},8:function(e,t){e.exports=r}})}));
//# sourceMappingURL=module.js.map