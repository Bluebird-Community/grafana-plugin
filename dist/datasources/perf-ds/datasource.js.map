{"version":3,"sources":["../../../src/datasources/perf-ds/datasource.js"],"names":["QueryType","interpolate","_","OpenNMSDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","basicAuth","withCredentials","interval","jsonData","timeInterval","timeout","parseInt","searchLimit","target","options","headers","Authorization","datasourceRequest","err","ret","statusText","cancelled","message","status","self","build","buildQuery","query","labels","request","source","length","doOpenNMSRequest","data","method","then","response","console","warn","reject","processMeasurementsResponse","catch","decorateError","title","undefined","resolve","interpolatedQuery","first","interpolateValue","nodeFilterRegex","nodeResourcesRegex","nodeFilterQuery","match","metricFindNodeFilterQuery","nodeCriteria","metricFindNodeResourceQuery","params","filterRule","limit","count","totalCount","results","each","node","id","toString","foreignId","foreignSource","push","text","label","value","expandable","encodeURIComponent","getNodeResource","depth","children","resource","resourceWithoutNodePrefix","start","range","from","valueOf","end","to","step","Math","floor","maxDataPoints","intervalMs","targets","transient","hide","Attribute","nodeId","resourceId","attribute","aggregation","subattribute","datasource","fallbackAttribute","concat","interpolateSourceVariables","scopedVars","interpolatedSource","getRemoteResourceId","Expression","expression","interpolateExpressionVariables","Filter","filter","interpolatedFilterParms","interpolateVariables","filterParameters","keys","filters","map","filterParms","parameters","key","callback","entry","object","attributes","variables","templateVariable","variable","isString","current","option","comparator","orderBy","order","sysName","interpolatedNodeId","flattenResourcesWithAttributes","interpolatedResourceId","remoteResourceId","toLowerCase","rrdGraphAttributes","indexOf","sort","columns","timestamps","series","i","j","nRows","nCols","datapoints","values","index","resources","resourcesWithAttributes","Object","prefix"],"mappings":"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","file":"datasource.js","sourcesContent":["import {QueryType} from './constants';\nimport {interpolate} from \"./interpolate\";\nimport _ from 'lodash';\n\nexport class OpenNMSDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    // This variable is referenced by the calculateInterval() method in metrics_panel_ctrl.ts\n    this.interval = (instanceSettings.jsonData || {}).timeInterval;\n\n    if (instanceSettings.jsonData && instanceSettings.jsonData.timeout) {\n        this.timeout = parseInt(instanceSettings.jsonData.timeout,10) * 1000;\n    }\n\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n\n    this.searchLimit = 25;\n    this.target = {};\n  }\n\n  doOpenNMSRequest(options) {\n    if (this.basicAuth || this.withCredentials) {\n      options.withCredentials = true;\n    }\n    if (this.basicAuth) {\n      options.headers = options.headers || {};\n      options.headers.Authorization = this.basicAuth;\n    }\n\n    options.url = this.url + options.url;\n    if (this.timeout) {\n      options.timeout = this.timeout;\n    }\n\n    return this.backendSrv.datasourceRequest(options);\n  };\n\n  decorateError(err) {\n    let ret = err;\n    if (err.err) {\n      ret = err.err;\n    }\n    let statusText = ret.statusText || 'Request failed.';\n\n    // cancelled property causes the UI to never complete on failure\n    if (ret.cancelled) {\n      delete ret.cancelled;\n      statusText = 'Request timed out.';\n    }\n    if (err.cancelled) {\n      delete err.cancelled;\n      statusText = 'Request timed out.';\n    }\n\n    if (!ret.message) {\n      ret.message = statusText;\n    }\n    if (!ret.status) {\n      ret.status = 'error';\n    }\n    return ret;\n  };\n\n  query(options) {\n    const self = this;\n\n    // Generate the query\n    var build = this.buildQuery(options);\n    var query = build.query;\n    var labels = build.labels;\n\n    // Issue the request\n    var request;\n    if (query.source.length > 0) {\n      request = this.doOpenNMSRequest({\n        url: '/rest/measurements',\n        data: query,\n        method: 'POST',\n        headers: {'Content-Type': 'application/json'}\n      });\n    } else {\n      // There are no sources listed, let Grafana display \"No data points\" to the user\n      return {'data': []};\n    }\n\n    // Convert the results to the expected format\n    return request.then((response) => {\n      if (response.status !== 200) {\n        console.warn('Successful response had status != 200:',response);\n        return self.$q.reject(response);\n      }\n      return OpenNMSDatasource.processMeasurementsResponse(response, labels);\n    }).catch(err => {\n      return self.$q.reject(self.decorateError(err));\n    });\n  }\n\n  // Used for testing the connection from the datasource configuration page\n  testDatasource() {\n    return this.doOpenNMSRequest({\n      url: '/rest/info',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n      } else {\n        return {\n          status: \"danger\",\n          message: \"OpenNMS provided a response, but no metadata was found.\",\n          title: \"Unexpected Response \" + response.status\n        }\n      }\n    }).catch(err => {\n      return this.decorateError(err);\n    });\n  }\n\n  // Used by template queries\n  metricFindQuery(query) {\n    if (query === null || query === undefined || query === \"\") {\n      return this.$q.resolve([]);\n    }\n\n    var interpolatedQuery = _.first(this.interpolateValue(query));\n    var nodeFilterRegex = /nodeFilter\\((.*)\\)/;\n    var nodeResourcesRegex = /nodeResources\\((.*)\\)/;\n\n    if (interpolatedQuery !== undefined) {\n      var nodeFilterQuery = interpolatedQuery.match(nodeFilterRegex);\n      if (nodeFilterQuery) {\n        return this.metricFindNodeFilterQuery(nodeFilterQuery[1]);\n      }\n\n      var nodeCriteria = interpolatedQuery.match(nodeResourcesRegex);\n      if (nodeCriteria) {\n        return this.metricFindNodeResourceQuery(nodeCriteria[1]);\n      }\n    }\n\n    return this.$q.resolve([]);\n  }\n\n  metricFindNodeFilterQuery(query) {\n    return this.doOpenNMSRequest({\n      url: '/rest/nodes',\n      method: 'GET',\n      params: {\n        filterRule: query,\n        limit: 0\n      }\n    }).then(function (response) {\n      if (response.data.count > response.data.totalCount) {\n        console.warn(\"Filter matches \" + response.data.totalCount + \" records, but only \" + response.data.count + \" will be used.\");\n      }\n      var results = [];\n      _.each(response.data.node, function (node) {\n        var nodeCriteria = node.id.toString();\n        if (node.foreignId !== null && node.foreignSource !== null) {\n          nodeCriteria = node.foreignSource + \":\" + node.foreignId;\n        }\n        results.push({text: node.label, value: nodeCriteria, expandable: true});\n      });\n      return results;\n    });\n  }\n\n  metricFindNodeResourceQuery(query) {\n    return this.doOpenNMSRequest({\n      url: '/rest/resources/' + encodeURIComponent(OpenNMSDatasource.getNodeResource(query)),\n      method: 'GET',\n      params: {\n        depth: 1\n      }\n    }).then(function (response) {\n      var results = [];\n      _.each(response.data.children.resource, function (resource) {\n        var resourceWithoutNodePrefix = resource.id.match(/node(Source)?\\[.*?\\]\\.(.*)/);\n        if (resourceWithoutNodePrefix) {\n          results.push({text: resourceWithoutNodePrefix[2], expandable: true});\n        }\n      });\n      return results;\n    });\n  }\n\n  buildQuery(options) {\n    var self = this,\n      start = options.range.from.valueOf(),\n      end = options.range.to.valueOf(),\n      step = Math.floor((end - start) / options.maxDataPoints);\n      step = (step < options.intervalMs) ? options.intervalMs : step;\n\n    var labels = [];\n\n    var query = {\n      \"start\": start,\n      \"end\": end,\n      \"step\": step,\n      \"maxrows\": options.maxDataPoints,\n      \"source\": [],\n      \"expression\": []\n    };\n\n    _.each(options.targets, function (target) {\n      var transient = \"false\";\n      if (target.hide) {\n        transient = true;\n      }\n\n      if (target.type === QueryType.Attribute) {\n        if (!((target.nodeId && target.resourceId && target.attribute))) {\n          return;\n        }\n\n        var label = target.label;\n        if (label === undefined || label === '') {\n          label = target.attribute;\n        }\n\n        // Build the source\n        var source = {\n          \"aggregation\": target.aggregation,\n          \"attribute\": target.attribute,\n          \"label\": label,\n          \"resourceId\": target.resourceId,\n          \"nodeId\": target.nodeId, // temporary attribute used for interpolation\n          \"transient\": transient\n        };\n\n        if (target.subattribute !== undefined && target.subattribute !== '') {\n          source.datasource = target.subattribute;\n        }\n        if (target.fallbackAttribute !== undefined && target.fallbackAttribute !== '') {\n          source['fallback-attribute'] = target.fallbackAttribute;\n        }\n\n        // Perform variable substitution - may generate additional queries\n        query.source = query.source.concat(self.interpolateSourceVariables(source, options.scopedVars, (interpolatedSource) => {\n          // Calculate the effective resource id after the interpolation\n          interpolatedSource.resourceId = OpenNMSDatasource.getRemoteResourceId(interpolatedSource.nodeId, interpolatedSource.resourceId);\n          delete interpolatedSource.nodeId;\n        }));\n\n        labels.push(label);\n\n      } else if (target.type === QueryType.Expression) {\n        if (!((target.label && target.expression))) {\n          return;\n        }\n\n        // Build the expression\n        var expression = {\n          \"label\": target.label,\n          \"value\": target.expression,\n          \"transient\": transient\n        };\n\n        // Perform variable substitution - may generate additional expressions\n        query.expression = query.expression.concat(self.interpolateExpressionVariables(expression, options.scopedVars));\n\n        labels.push(target.label);\n\n      } else if (target.type === QueryType.Filter) {\n        if (!((target.filter))) {\n          return;\n        }\n\n        // Interpolate the filter parameters\n        var interpolatedFilterParms = self.interpolateVariables(target.filterParameters, _.keys(target.filterParameters), options.scopedVars);\n\n        var filters = _.map(interpolatedFilterParms, (filterParms) => {\n          // Build the filter definition\n          var parameters = [];\n          _.each(filterParms, function (value, key) {\n            // Skip parameters with undefined or empty values\n            if (value === undefined || value === '' || value === null) {\n              return;\n            }\n\n            parameters.push({\n              'key': key,\n              'value': value\n            });\n          });\n\n          return {\n            \"name\": target.filter.name,\n            \"parameter\": parameters\n          };\n        });\n\n        // Only add the filter attribute to the query when one or more filters are specified since\n        // OpenNMS versions before 17.0.0 do not support it\n        if (!query.filter) {\n          query.filter = filters;\n        } else {\n          query.filter = query.filter.concat(filters);\n        }\n      }\n    });\n\n    return {'query': query, 'labels': labels};\n  }\n\n  interpolateSourceVariables(source, scopedVars, callback) {\n    return this.interpolateVariables(source, ['nodeId', 'resourceId', 'attribute', 'datasource', 'label'], scopedVars, callback);\n  }\n\n  interpolateExpressionVariables(expression, scopedVars) {\n    return this.interpolateVariables(expression, ['value', 'label'], scopedVars);\n  }\n\n  interpolateValue(value, scopedVars) {\n    return _.map(this.interpolateVariables({'value': value}, ['value'], scopedVars), function(entry) {\n      return entry.value;\n    });\n  }\n\n  interpolateVariables(object, attributes, scopedVars, callback) {\n    // Reformat the variables to work with our interpolate function\n    var variables = [];\n    _.each(this.templateSrv.variables, function(templateVariable) {\n      var variable = {\n        name: templateVariable.name,\n        value: []\n      };\n\n      // If this templateVar exists in scopedVars, we need to look at the scoped values\n      if (scopedVars && scopedVars[variable.name] !== undefined) {\n        variable.value.push(scopedVars[variable.name].value);\n      } else {\n        // Single-valued?\n        if (_.isString(templateVariable.current.value)) {\n          variable.value.push(templateVariable.current.value);\n        } else {\n          _.each(templateVariable.current.value, function(value) {\n            if (value === \"$__all\") {\n              _.each(templateVariable.options, function(option) {\n                // \"All\" is part of the options, so make sure to skip that one\n                if (option.value !== \"$__all\") {\n                  variable.value.push(option.value);\n                }\n              });\n            } else {\n              variable.value.push(value);\n            }\n          });\n        }\n      }\n\n      variables.push(variable);\n    });\n    return interpolate(object, attributes, variables, callback);\n  }\n\n  static processMeasurementsResponse(response, order) {\n    var labels = response.data.labels;\n    var columns = response.data.columns;\n    var timestamps = response.data.timestamps;\n    var series = [];\n    var i, j, nRows, nCols, datapoints;\n\n    if (timestamps !== undefined) {\n      nRows = timestamps.length;\n      nCols = columns.length;\n\n      for (i = 0; i < nCols; i++) {\n        datapoints = [];\n        for (j = 0; j < nRows; j++) {\n          // Skip rows that are out-of-ranges - this can happen with RRD data in narrow time spans\n          if (timestamps[j] < response.data.start || timestamps[j] > response.data.end) {\n            continue;\n          }\n\n          datapoints.push([columns[i].values[j], timestamps[j]]);\n        }\n\n        // Get the insertion index defined by the order and insert series right there\n        let index = order.indexOf(labels[i]);\n        series[index] = {\n          target: labels[i],\n          datapoints: datapoints\n        };\n      }\n    }\n\n    return {data: series};\n  }\n\n  static flattenResourcesWithAttributes(resources, resourcesWithAttributes) {\n    _.each(resources, function (resource) {\n      if (resource.rrdGraphAttributes !== undefined && Object.keys(resource.rrdGraphAttributes).length > 0) {\n        resourcesWithAttributes.push(resource);\n      }\n      if (resource.children !== undefined && resource.children.resource.length > 0) {\n        OpenNMSDatasource.flattenResourcesWithAttributes(resource.children.resource, resourcesWithAttributes);\n      }\n    });\n    return resourcesWithAttributes;\n  }\n\n  static getNodeResource(nodeId) {\n    var prefix = \"\";\n    if (nodeId.indexOf(\":\") > 0) {\n      prefix = \"nodeSource[\";\n    } else {\n      prefix = \"node[\";\n    }\n    return prefix + nodeId + \"]\";\n  }\n\n  static getRemoteResourceId(nodeId, resourceId) {\n    return OpenNMSDatasource.getNodeResource(nodeId) + \".\" + resourceId;\n  }\n\n  searchForNodes(query) {\n    return this.doOpenNMSRequest({\n      url: '/rest/nodes',\n      method: 'GET',\n      params: {\n        limit: this.searchLimit,\n        match: 'any',\n        comparator: 'ilike',\n        orderBy: 'id',\n        order: 'asc',\n        label: '%' + query + '%',\n        sysName: '%' + query + '%',\n        'ipInterface.ipAddress': '%' + query + '%',\n        'ipInterface.ipHostName': '%' + query + '%',\n        'foreignId': query + '%' // doesn't support leading '%'\n      }\n    });\n  }\n\n  getResourcesWithAttributesForNode(nodeId) {\n    var interpolatedNodeId = _.first(this.interpolateValue(nodeId));\n\n    return this.doOpenNMSRequest({\n      url: '/rest/resources/fornode/' + encodeURIComponent(interpolatedNodeId),\n      method: 'GET',\n      params: {\n        depth: -1\n      }\n    }).then(function (results) {\n      return OpenNMSDatasource.flattenResourcesWithAttributes([results.data], []);\n    });\n  }\n\n  getAvailableFilters() {\n    return this.doOpenNMSRequest({\n      url: '/rest/measurements/filters',\n      method: 'GET'\n    });\n  }\n\n  suggestAttributes(nodeId, resourceId, query) {\n    var interpolatedNodeId = _.first(this.interpolateValue(nodeId)),\n        interpolatedResourceId = _.first(this.interpolateValue(resourceId));\n    var remoteResourceId = OpenNMSDatasource.getRemoteResourceId(interpolatedNodeId, interpolatedResourceId);\n\n    return this.doOpenNMSRequest({\n      url: '/rest/resources/' + encodeURIComponent(remoteResourceId),\n      method: 'GET',\n      params: {\n        depth: -1\n      }\n    }).then(function (results) {\n      query = query.toLowerCase();\n      var attributes = [];\n      _.each(results.data.rrdGraphAttributes, function (value, key) {\n        if (key.toLowerCase().indexOf(query) >= 0) {\n          attributes.push(key);\n        }\n      });\n      attributes.sort();\n\n      return attributes;\n    });\n  }\n}\n"]}